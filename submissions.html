<!doctype html>
<html lang="en">
<head>
<meta charset="utf-8">
<meta name="viewport" content="width=device-width, initial-scale=1">
<title>Kacper's List Submissions</title>
<style>
  :root{ --accent1:#53baff; --accent2:#6be3ff; --muted:rgba(255,255,255,0.65); }
  body{ margin:0; font-family:'Segoe UI',Roboto,Helvetica,Arial; background:#111; color:#fff; display:flex; justify-content:center; align-items:flex-start; min-height:100vh; padding:28px; box-sizing:border-box;}
  .container{ width:95%; max-width:1300px; background: rgba(255,255,255,0.03); padding:20px; border-radius:16px; backdrop-filter: blur(8px); border:1px solid rgba(255,255,255,0.04); box-shadow: 0 10px 30px rgba(0,0,0,0.6);}
  h1{ text-align:center; margin:8px 0 18px 0; }
  .grid{ display:grid; grid-template-columns: 1fr 340px 300px; gap:18px; align-items:start; }
  .panel{ background: rgba(0,0,0,0.25); padding:12px; border-radius:12px; }
  .sub-table{ width:100%; border-collapse:collapse; }
  .sub-table th, .sub-table td{ padding:10px; border-bottom:1px solid rgba(255,255,255,0.05); text-align:left; vertical-align:middle; }
  .sub-table th{ font-weight:700; background: rgba(255,255,255,0.02); }
  .rank-input{ width:70px; padding:6px 8px; border-radius:8px; border:none; outline:none; }
  button{ padding:8px 10px; border-radius:8px; border:none; cursor:pointer; font-weight:700; }
  .accept{ background:#4CAF50; color:#fff; }
  .decline{ background:#F44336; color:#fff; }
  .leaderboard-preview{ display:flex; flex-direction:column; gap:10px; max-height:420px; overflow:auto; }
  .lb-card{ background: rgba(255,255,255,0.03); border-radius:10px; padding:8px; display:flex; gap:8px; align-items:center; position:relative; }
  .lb-left{ min-width:110px; max-width:140px; height:80px; border-radius:6px; overflow:hidden; background:rgba(0,0,0,0.3); display:flex; align-items:center; justify-content:center; }
  .lb-left iframe{ width:100%; height:100%; border:0; }
  .lb-mid{ flex:1; display:flex; flex-direction:column; gap:6px; }
  .lb-rank{ font-size:1.2rem; font-weight:800; color:var(--accent1); min-width:48px; }
  .lb-title{ font-weight:700; }
  .lb-creator{ color:var(--muted); font-size:0.95rem; }
  .lb-actions{ position:absolute; top:8px; right:8px; display:flex; gap:6px; }
  .remove-btn{ background:#ff6b6b; color:#fff; border-radius:8px; padding:6px 8px; cursor:pointer; border:none; font-weight:700; }

  .password-overlay{ position:fixed; inset:0; background:rgba(0,0,0,0.88); z-index:60; display:flex; align-items:center; justify-content:center; flex-direction:column; gap:10px; }
  .password-overlay input{ padding:12px 14px; border-radius:10px; border:none; outline:none; width:260px; }
  .password-overlay button{ padding:10px 18px; border-radius:10px; border:none; cursor:pointer; background:linear-gradient(135deg,var(--accent1),var(--accent2)); color:#fff; font-weight:700; }
  .error-msg{ color:#ff6b6b; display:none; }

  .users-list { display:flex; flex-direction:column; gap:8px; max-height:340px; overflow:auto; }
  .user-row { display:flex; gap:8px; align-items:center; justify-content:space-between; background: rgba(255,255,255,0.02); padding:8px; border-radius:8px; }
  .user-name { font-weight:700; }
  .user-actions { display:flex; gap:6px; }

  /* delete + rename overlay */
  .overlay-delete { position:fixed; inset:0; display:none; align-items:center; justify-content:center; z-index:80; background:rgba(0,0,0,0.6); }
  .overlay-delete .popup { width:420px; }

  .export-row { display:flex; gap:8px; margin-top:10px; }

  @media (max-width:1100px){
    .grid{ grid-template-columns: 1fr 1fr; }
  }
  @media (max-width:780px){
    .grid{ grid-template-columns: 1fr; }
  }
</style>
</head>
<body>
<div class="password-overlay" id="passwordOverlay">
  <h2 style="margin:0">Enter Admin Password</h2>
  <input type="password" id="passInput" placeholder="Admin password">
  <div style="display:flex; gap:8px;">
    <button id="passBtn">Enter</button>
  </div>
  <div class="error-msg" id="passError">Wrong password!</div>
</div>

<div class="container" id="mainContainer" style="display:none;">
  <h1>All Submissions & Leaderboard Manager</h1>
  <div class="grid">
    <div class="panel" style="min-height:380px;">
      <h3 style="margin:0 0 8px 0">Submissions</h3>
      <table class="sub-table" id="submissionTable">
        <thead>
          <tr>
            <th>#</th><th>Level</th><th>Creator</th><th>Submitted by</th><th>YT</th><th>Actions</th>
          </tr>
        </thead>
        <tbody></tbody>
      </table>
    </div>

    <div class="panel">
      <h3 style="margin:0 0 8px 0">Users</h3>
      <div style="margin-bottom:8px;">
        <input type="text" id="manualUserName" placeholder="Add user (username)" style="width:100%; padding:8px; border-radius:8px; border:none; background:rgba(255,255,255,0.03); color:#fff;">
        <div style="display:flex; gap:8px; margin-top:8px;">
          <button id="addUserBtn" style="flex:1; background:linear-gradient(135deg,var(--accent1),var(--accent2)); color:#fff;">Add User</button>
          <button id="reloadUsersBtn" style="flex:1; background:transparent; border:1px solid rgba(255,255,255,0.06);">Reload</button>
        </div>
      </div>
      <div class="users-list" id="usersList"></div>

      <div class="export-row">
        <button id="exportUsers" style="flex:1; background:linear-gradient(135deg,var(--accent1),var(--accent2)); color:#fff;">Export users.json</button>
        <button id="exportTerminated" style="flex:1; background:transparent; border:1px solid rgba(255,255,255,0.06);">Export terminated.json</button>
      </div>
    </div>

    <div class="panel">
      <h3 style="margin:0 0 8px 0">Leaderboard Preview</h3>
      <div class="leaderboard-preview" id="lbPreview"></div>
      <div style="margin-top:12px; color:var(--muted); font-size:0.92rem;">Click the red X to remove an entry from the leaderboard.</div>

      <div class="export-row" style="margin-top:12px;">
        <button id="exportSubmissions" style="flex:1; background:linear-gradient(135deg,var(--accent1),var(--accent2)); color:#fff;">Export submissions.json</button>
        <button id="exportLeaderboard" style="flex:1; background:transparent; border:1px solid rgba(255,255,255,0.06);">Export leaderboard.json</button>
      </div>
    </div>
  </div>
</div>

<!-- Delete overlay that requests a termination reason -->
<div class="overlay-delete" id="deleteOverlay">
  <div class="popup">
    <h3>Delete / Ban User</h3>
    <p style="margin:0 0 6px 0; color:var(--muted)">Enter a reason for termination (user will see this on refresh):</p>
    <input type="text" id="delReason" placeholder="Reason for termination">
    <div class="actions" style="margin-top:8px;">
      <button id="confirmDelete" class="btn">Delete & Ban</button>
      <button id="cancelDelete" class="btn btn-ghost">Cancel</button>
    </div>
  </div>
</div>

<script>
/* Admin password for the manager (this gate is purely UI-level; choose a strong password):
   In this static approach the "admin password" is only used to show the UI. The actual data edits are local and exported as JSON.
*/
const ADMIN_PASSWORD = "spring@53!rç";

/* ---------- Local data mirrors ----------
   The submissions page will fetch the same JSON files that index.html uses.
   All mutations are kept in memory and in localStorage; admin can use Export buttons to download JSON files.
*/
let DATA = {
  users: [],
  submissions: [],
  leaderboard: [],
  terminated: {}
};

/* ---------- DOM elements ---------- */
const overlay = document.getElementById('passwordOverlay');
const passInput = document.getElementById('passInput');
const passBtn = document.getElementById('passBtn');
const passError = document.getElementById('passError');
const mainContainer = document.getElementById('mainContainer');
const tbody = document.querySelector('#submissionTable tbody');
const lbPreview = document.getElementById('lbPreview');

const usersListEl = document.getElementById('usersList');
const addUserBtn = document.getElementById('addUserBtn');
const manualUserName = document.getElementById('manualUserName');
const reloadUsersBtn = document.getElementById('reloadUsersBtn');

const deleteOverlay = document.getElementById('deleteOverlay');
const delReasonInput = document.getElementById('delReason');
const confirmDeleteBtn = document.getElementById('confirmDelete');
const cancelDeleteBtn = document.getElementById('cancelDelete');

const exportUsersBtn = document.getElementById('exportUsers');
const exportTerminatedBtn = document.getElementById('exportTerminated');
const exportSubmissionsBtn = document.getElementById('exportSubmissions');
const exportLeaderboardBtn = document.getElementById('exportLeaderboard');

let userToDelete = null;

/* ---------- Helpers ---------- */
async function fetchJSON(path){
  try{
    const r = await fetch(path, {cache: "no-store"});
    if(!r.ok) throw new Error('fetch failed');
    return await r.json();
  }catch(e){
    return null;
  }
}
function persistAllToLocal(){
  localStorage.setItem('users', JSON.stringify(DATA.users));
  localStorage.setItem('submissions', JSON.stringify(DATA.submissions));
  localStorage.setItem('leaderboard', JSON.stringify(DATA.leaderboard));
  localStorage.setItem('terminated', JSON.stringify(DATA.terminated));
}
function downloadJSON(filename, obj){
  const blob = new Blob([JSON.stringify(obj, null, 2)], {type:'application/json'});
  const url = URL.createObjectURL(blob);
  const a = document.createElement('a');
  a.href = url;
  a.download = filename;
  document.body.appendChild(a);
  a.click();
  a.remove();
  URL.revokeObjectURL(url);
}
function generateTag(usersList){
  const users = usersList || DATA.users;
  const taken = new Set(users.map(u => u.tag));
  for(let i=1;i<10000;i++){
    const t = String(i).padStart(4,'0');
    if(!taken.has(t)) return t;
  }
  return String(Date.now()).slice(-4);
}
function findUserByName(name){
  if(!name) return null;
  return DATA.users.find(u => u.username.toLowerCase() === name.toLowerCase()) || null;
}
function escapeHtml(s){ if(!s) return ''; return s.replace(/[&<>"']/g, function(m){ return {'&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;',"'":'&#39;'}[m]; }); }
function escapeAttr(s){ return s ? s.replace(/"/g,'&quot;') : ''; }
function extractYouTubeId(url){
  if(!url) return null;
  const regex = /(?:v=|\/embed\/|\.be\/|v\/|vi=)([A-Za-z0-9_-]{6,11})/;
  const m = url.match(regex);
  if(m && m[1]) return m[1];
  return null;
}

/* ---------- Boot & Admin auth ---------- */
passBtn.addEventListener('click', async ()=>{
  const input = passInput.value || '';
  // basic client-side gate
  if(input === ADMIN_PASSWORD){
    overlay.style.display='none';
    mainContainer.style.display='block';
    await loadInitialData();
    loadSubmissions();
    loadLeaderboardPreview();
    loadUsersPanel();
  } else {
    passError.style.display='block';
    setTimeout(()=> passError.style.display='none', 1400);
  }
});

/* load initial JSONs (or fall back to localStorage) */
async function loadInitialData(){
  const [u,s,l,t] = await Promise.all([
    fetchJSON('users.json'),
    fetchJSON('submissions.json'),
    fetchJSON('leaderboard.json'),
    fetchJSON('terminated.json')
  ]);
  DATA.users = Array.isArray(u) ? u : (JSON.parse(localStorage.getItem('users')||'null') || []);
  DATA.submissions = Array.isArray(s) ? s : (JSON.parse(localStorage.getItem('submissions')||'null') || []);
  DATA.leaderboard = Array.isArray(l) ? l : (JSON.parse(localStorage.getItem('leaderboard')||'null') || []);
  DATA.terminated = (t && typeof t === 'object') ? t : (JSON.parse(localStorage.getItem('terminated')||'{}') || {});
  // normalize
  for(const usr of DATA.users){
    if(typeof usr.mto === 'undefined') usr.mto = false;
    if(typeof usr.isBanned === 'undefined') usr.isBanned = false;
    if(!usr.tag) usr.tag = generateTag(DATA.users);
    if(!usr.passwordHash) usr.passwordHash = ''; // empty if none
  }
  persistAllToLocal();
}

/* ---------- Submissions table rendering ---------- */
function loadSubmissions(){
  tbody.innerHTML='';
  const submissions = DATA.submissions || [];
  if(submissions.length === 0){
    const tr = document.createElement('tr');
    tr.innerHTML = `<td colspan="6" style="opacity:.8; text-align:center; padding:20px;">No pending submissions.</td>`;
    tbody.appendChild(tr);
    return;
  }
  submissions.forEach((sub,i)=>{
    const tr = document.createElement('tr');
    tr.innerHTML = `
      <td>${i+1}</td>
      <td style="max-width:180px;">${escapeHtml(sub.name)}</td>
      <td>${escapeHtml(sub.creator)}</td>
      <td>${escapeHtml(sub.submittedBy || 'Unknown')}</td>
      <td><a href="${escapeAttr(sub.youtube)}" target="_blank" style="color:var(--accent1);">Link</a></td>
      <td>
        <input type="number" min="1" class="rank-input" placeholder="Rank">
        <button class="accept">Approve</button>
        <button class="decline">Decline</button>
      </td>
    `;
    tbody.appendChild(tr);

    // Decline removes submission
    tr.querySelector('.decline').addEventListener('click', ()=> {
      DATA.submissions.splice(i,1);
      persistAllToLocal();
      loadSubmissions();
      alert('Submission removed.');
    });

    // Approve: add to leaderboard only via admin
    tr.querySelector('.accept').addEventListener('click', ()=> {
      const rankInput = tr.querySelector('.rank-input');
      const rank = parseInt(rankInput.value);
      if(!rank || rank < 1){ alert('Enter a valid rank number (>=1)'); return; }
      // bump existing entries that are >= rank
      DATA.leaderboard.forEach(entry=>{
        if(Number(entry.rank) >= rank) entry.rank = Number(entry.rank) + 1;
      });
      // push new entry with rank
      DATA.leaderboard.push({ name: sub.name, creator: sub.creator, submittedBy: sub.submittedBy, youtube: sub.youtube, rank });
      DATA.leaderboard.sort((a,b)=>Number(a.rank) - Number(b.rank));
      // remove submission
      DATA.submissions.splice(i,1);
      persistAllToLocal();
      loadSubmissions();
      loadLeaderboardPreview();
      alert('Approved and added to leaderboard.');
    });
  });
}

/* ---------- Users panel ---------- */
function loadUsersPanel(){
  usersListEl.innerHTML = '';
  const users = DATA.users || [];
  if(users.length === 0){
    const e = document.createElement('div');
    e.style.color = 'var(--muted)';
    e.textContent = 'No users yet.';
    usersListEl.appendChild(e);
    return;
  }

  users.forEach(u=>{
    const row = document.createElement('div');
    row.className = 'user-row';
    const left = document.createElement('div');
    left.style.display='flex';
    left.style.flexDirection='column';
    left.innerHTML = `<div class="user-name">${escapeHtml(u.username)}${u.mto ? ' <span style="color:#ffdd55;font-weight:700">MTO</span>':''} ${u.isBanned ? '<span style="color:#ff6b6b;font-weight:700">BANNED</span>':''}</div><small style="color:var(--muted)">#${u.tag}</small>`;

    const actions = document.createElement('div');
    actions.className = 'user-actions';
    const renameBtn = document.createElement('button');
    renameBtn.textContent = 'Rename';
    renameBtn.style.background = 'linear-gradient(135deg,var(--accent1),var(--accent2))';
    renameBtn.style.color = '#000';
    const removeBtn = document.createElement('button');
    removeBtn.textContent = 'Remove';
    removeBtn.style.background = '#ff6b6b';
    removeBtn.style.color = '#fff';
    const mtoBtn = document.createElement('button');
    mtoBtn.textContent = u.mto ? 'Demote MTO' : 'Promote MTO';
    mtoBtn.style.background = u.mto ? '#555' : 'gold';
    mtoBtn.style.color = u.mto ? '#fff' : '#000';

    renameBtn.addEventListener('click', ()=> {
      const newName = prompt('Enter new username for "' + u.username + '"', u.username);
      if(!newName) return;
      if(newName.trim().length < 2){ alert('Username must be at least 2 characters'); return; }
      const existing = findUserByName(newName.trim());
      if(existing && existing.username.toLowerCase() !== u.username.toLowerCase()){ alert('That username is already taken'); return; }
      // perform rename in users
      for(let uu of DATA.users){ if(uu.username.toLowerCase() === u.username.toLowerCase()){ uu.username = newName.trim(); } }
      // update submissions & leaderboard references
      DATA.submissions.forEach(s => { if(s.submittedBy && s.submittedBy.toLowerCase() === u.username.toLowerCase()) s.submittedBy = newName.trim(); });
      DATA.leaderboard.forEach(e => { if(e.submittedBy && e.submittedBy.toLowerCase() === u.username.toLowerCase()) e.submittedBy = newName.trim(); });
      // move termination reason if present
      if(DATA.terminated[u.username]){
        DATA.terminated[newName.trim()] = DATA.terminated[u.username];
        delete DATA.terminated[u.username];
      }
      persistAllToLocal();
      loadUsersPanel();
      loadSubmissions();
      loadLeaderboardPreview();
      alert('Renamed.');
    });

    removeBtn.addEventListener('click', ()=> {
      // open delete overlay and set userToDelete
      userToDelete = u;
      delReasonInput.value = '';
      deleteOverlay.style.display = 'flex';
    });

    mtoBtn.addEventListener('click', ()=>{
      for(let uu of DATA.users){
        if(uu.username.toLowerCase() === u.username.toLowerCase()){
          uu.mto = !uu.mto;
        }
      }
      persistAllToLocal();
      loadUsersPanel();
      alert(`User "${u.username}" MTO toggled.`);
    });

    actions.appendChild(renameBtn);
    actions.appendChild(removeBtn);
    actions.appendChild(mtoBtn);
    row.appendChild(left);
    row.appendChild(actions);
    usersListEl.appendChild(row);
  });
}

/* delete/ban confirm */
confirmDeleteBtn.addEventListener('click', ()=>{
  if(!userToDelete) return;
  const reason = delReasonInput.value.trim();
  if(!reason){ alert('Enter a reason'); return; }
  // mark as banned and remove from users list or keep but flag? Requirement: remove user from user list and also they can't log in and see reason
  // We will set isBanned true and remove user from users array (as requested).
  // Save termination reason in DATA.terminated
  DATA.terminated[userToDelete.username] = reason;
  // Remove user object
  DATA.users = DATA.users.filter(uu => uu.username.toLowerCase() !== userToDelete.username.toLowerCase());
  // Remove their submissions
  DATA.submissions = DATA.submissions.filter(s => !(s.submittedBy && s.submittedBy.toLowerCase() === userToDelete.username.toLowerCase()));
  // Remove their leaderboard entries
  DATA.leaderboard = DATA.leaderboard.filter(e => !(e.submittedBy && e.submittedBy.toLowerCase() === userToDelete.username.toLowerCase()));
  persistAllToLocal();
  deleteOverlay.style.display = 'none';
  userToDelete = null;
  loadUsersPanel();
  loadSubmissions();
  loadLeaderboardPreview();
  alert('User removed (and banned). Termination reason saved locally. Export terminated.json to persist.');
});
cancelDeleteBtn.addEventListener('click', ()=>{
  deleteOverlay.style.display = 'none';
  userToDelete = null;
});

/* add user manually */
addUserBtn.addEventListener('click', ()=> {
  const name = manualUserName.value.trim();
  if(!name || name.length < 2){ alert('Enter a username (min 2 chars)'); return; }
  if(findUserByName(name)){ alert('That username already exists'); return; }
  const tag = generateTag(DATA.users);
  // passwordHash empty by default; admin can later export and insert hashes
  DATA.users.push({ username: name, tag, passwordHash: '', createdAt: Date.now(), mto: false, isBanned: false });
  persistAllToLocal();
  manualUserName.value = '';
  loadUsersPanel();
  alert('User added.');
});
reloadUsersBtn.addEventListener('click', loadUsersPanel);

/* leaderboard preview */
function loadLeaderboardPreview(){
  lbPreview.innerHTML = '';
  const leaderboard = (DATA.leaderboard || []).map(x=>({...x, rank: Number(x.rank) || 9999})).sort((a,b)=>a.rank-b.rank);

  if(leaderboard.length === 0){
    const e = document.createElement('div');
    e.style.color = 'var(--muted)';
    e.style.opacity = 0.85;
    e.textContent = 'No leaderboard entries yet.';
    lbPreview.appendChild(e);
    return;
  }

  leaderboard.forEach((entry, idx)=>{
    const card = document.createElement('div');
    card.className = 'lb-card';

    const left = document.createElement('div');
    left.className = 'lb-left';
    const ytId = extractYouTubeId(entry.youtube);
    if(ytId){
      const iframe = document.createElement('iframe');
      iframe.src = `https://www.youtube.com/embed/${ytId}`;
      iframe.allow = 'accelerometer; autoplay; clipboard-write; encrypted-media; gyroscope; picture-in-picture';
      iframe.allowFullscreen = true;
      left.appendChild(iframe);
    } else {
      left.textContent = '—';
    }

    const mid = document.createElement('div');
    mid.className = 'lb-mid';
    mid.innerHTML = `<div style="display:flex;align-items:center;gap:8px;"><div class="lb-rank">${entry.rank}</div><div class="lb-title">${escapeHtml(entry.name)}</div></div><div class="lb-creator">by ${escapeHtml(entry.creator)} • sent by ${escapeHtml(entry.submittedBy||'Unknown')}</div>`;

    const actions = document.createElement('div');
    actions.className = 'lb-actions';
    const removeBtn = document.createElement('button');
    removeBtn.className = 'remove-btn';
    removeBtn.textContent = 'X';
    removeBtn.title = 'Remove from leaderboard';
    removeBtn.addEventListener('click', ()=> {
      if(!confirm(`Remove "${entry.name}" from leaderboard?`)) return;
      DATA.leaderboard = DATA.leaderboard.filter((e,i2)=> !(e.name===entry.name && e.creator===entry.creator && Number(e.rank)===Number(entry.rank) && e.youtube===entry.youtube) );
      persistAllToLocal();
      loadLeaderboardPreview();
      alert('Removed.');
    });

    actions.appendChild(removeBtn);
    card.appendChild(left);
    card.appendChild(mid);
    card.appendChild(actions);
    lbPreview.appendChild(card);
  });
}

/* Export buttons (admin downloads updated JSON) */
exportUsersBtn.addEventListener('click', ()=> {
  downloadJSON('users.json', DATA.users);
});
exportTerminatedBtn.addEventListener('click', ()=> {
  downloadJSON('terminated.json', DATA.terminated);
});
exportSubmissionsBtn.addEventListener('click', ()=> {
  downloadJSON('submissions.json', DATA.submissions);
});
exportLeaderboardBtn.addEventListener('click', ()=> {
  downloadJSON('leaderboard.json', DATA.leaderboard);
});

/* Expose helper to index page: index calls window.getDataForAdmin() — but since pages are separate,
   we provide the same functionality by saving into localStorage. Index already reads localStorage fallback.
*/

/* Boot: nothing until admin password entered (pass overlay) */

</script>
</body>
</html>
