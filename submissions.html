<!doctype html>
<html lang="en">
<head>
<meta charset="utf-8">
<meta name="viewport" content="width=device-width, initial-scale=1">
<title>Kacper's List Submissions</title>
<style>
  /* (styling same as your admin UI but slightly extended) */
  :root{ --accent1:#53baff; --accent2:#6be3ff; --muted:rgba(255,255,255,0.65); }
  body{ margin:0; font-family:'Segoe UI',Roboto,Helvetica,Arial; background:#111; color:#fff; display:flex; justify-content:center; align-items:flex-start; min-height:100vh; padding:28px; box-sizing:border-box;}
  .container{ width:95%; max-width:1300px; background: rgba(255,255,255,0.03); padding:20px; border-radius:16px; backdrop-filter: blur(8px); border:1px solid rgba(255,255,255,0.04); box-shadow: 0 10px 30px rgba(0,0,0,0.6);}
  h1{ text-align:center; margin:8px 0 18px 0; }
  .grid{ display:grid; grid-template-columns: 1fr 320px 300px; gap:18px; align-items:start; }
  .panel{ background: rgba(0,0,0,0.25); padding:12px; border-radius:12px; }
  .sub-table{ width:100%; border-collapse:collapse; }
  .sub-table th, .sub-table td{ padding:10px; border-bottom:1px solid rgba(255,255,255,0.05); text-align:left; vertical-align:middle; }
  .sub-table th{ font-weight:700; background: rgba(255,255,255,0.02); }
  .rank-input{ width:70px; padding:6px 8px; border-radius:8px; border:none; outline:none; }
  button{ padding:8px 10px; border-radius:8px; border:none; cursor:pointer; font-weight:700; }
  .accept{ background:#4CAF50; color:#fff; }
  .decline{ background:#F44336; color:#fff; }
  .leaderboard-preview{ display:flex; flex-direction:column; gap:10px; max-height:420px; overflow:auto; }
  .lb-card{ background: rgba(255,255,255,0.03); border-radius:10px; padding:8px; display:flex; gap:8px; align-items:center; position:relative; }
  .lb-left{ min-width:110px; max-width:140px; height:80px; border-radius:6px; overflow:hidden; background:rgba(0,0,0,0.3); display:flex; align-items:center; justify-content:center; }
  .lb-mid{ flex:1; display:flex; flex-direction:column; gap:6px; }
  .lb-rank{ font-size:1.2rem; font-weight:800; color:var(--accent1); min-width:48px; }
  .lb-title{ font-weight:700; }
  .lb-creator{ color:var(--muted); font-size:0.95rem; }
  .lb-actions{ position:absolute; top:8px; right:8px; display:flex; gap:6px; }
  .remove-btn{ background:#ff6b6b; color:#fff; border-radius:8px; padding:6px 8px; cursor:pointer; border:none; font-weight:700; }

  .password-overlay{ position:fixed; inset:0; background:rgba(0,0,0,0.88); z-index:60; display:flex; align-items:center; justify-content:center; flex-direction:column; gap:10px; }
  .password-overlay input{ padding:12px 14px; border-radius:10px; border:none; outline:none; width:260px; }
  .password-overlay button{ padding:10px 18px; border-radius:10px; border:none; cursor:pointer; background:linear-gradient(135deg,var(--accent1),var(--accent2)); color:#fff; font-weight:700; }
  .error-msg{ color:#ff6b6b; display:none; }

  .users-list { display:flex; flex-direction:column; gap:8px; max-height:420px; overflow:auto; }
  .user-row { display:flex; gap:8px; align-items:center; justify-content:space-between; background: rgba(255,255,255,0.02); padding:8px; border-radius:8px; }
  .user-name { font-weight:700; }
  .user-actions { display:flex; gap:6px; }

  .overlay-delete { position:fixed; inset:0; display:none; align-items:center; justify-content:center; z-index:80; background:rgba(0,0,0,0.6); }
  .overlay-delete .popup { width:420px; }

  .github-config{ display:flex; gap:8px; margin-top:12px; flex-direction:column; }
  .github-config input{ padding:8px; border-radius:8px; border:none; background:rgba(255,255,255,0.03); color:#fff; }

  @media (max-width:1100px){ .grid{ grid-template-columns: 1fr 1fr; } }
  @media (max-width:780px){ .grid{ grid-template-columns: 1fr; } }
</style>
</head>
<body>
<div class="password-overlay" id="passwordOverlay">
  <h2 style="margin:0">Enter Admin Password</h2>
  <input type="password" id="passInput" placeholder="Password">
  <div style="display:flex; gap:8px;">
    <button id="passBtn">Enter</button>
  </div>
  <div class="error-msg" id="passError">Wrong password!</div>
  <div style="margin-top:12px; color:var(--muted); font-size:0.9rem;">Admin password is only a simple gate for this page — GitHub commits require a token below.</div>
</div>

<div class="container" id="mainContainer" style="display:none;">
  <h1>All Submissions & Leaderboard Manager</h1>
  <div class="grid">
    <div class="panel" style="min-height:380px;">
      <h3 style="margin:0 0 8px 0">Submissions</h3>
      <table class="sub-table" id="submissionTable">
        <thead>
          <tr><th>#</th><th>Level</th><th>Creator</th><th>Submitted by</th><th>YT</th><th>Actions</th></tr>
        </thead>
        <tbody></tbody>
      </table>
      <div style="margin-top:12px; color:var(--muted); font-size:0.9rem;">Approve moves a submission into <code>leaderboard.json</code> (you must commit to persist).</div>
    </div>

    <div class="panel">
      <h3 style="margin:0 0 8px 0">Users</h3>
      <div style="margin-bottom:8px;">
        <input type="text" id="manualUserName" placeholder="Add user (username)" style="width:100%; padding:8px; border-radius:8px; border:none; background:rgba(255,255,255,0.03); color:#fff;">
        <div style="display:flex; gap:8px; margin-top:8px;">
          <button id="addUserBtn" style="flex:1; background:linear-gradient(135deg,var(--accent1),var(--accent2)); color:#fff;">Add User</button>
          <button id="reloadUsersBtn" style="flex:1; background:transparent; border:1px solid rgba(255,255,255,0.06);">Reload</button>
        </div>
      </div>
      <div class="users-list" id="usersList"></div>

      <div style="margin-top:12px;">
        <h4>GitHub persistence (optional)</h4>
        <div class="github-config">
          <input id="ghRepo" placeholder="owner/repo (e.g. you/your-repo)"/>
          <input id="ghBranch" placeholder="branch (default: main)" />
          <input id="ghToken" placeholder="GitHub Personal Access Token (paste here to enable writes)" type="password" />
          <div style="display:flex; gap:8px;">
            <button id="testGh" style="flex:1; background:linear-gradient(135deg,var(--accent1),var(--accent2));">Test GitHub</button>
            <button id="saveGh" style="flex:1; background:#4caf50">Save Current Files to Repo</button>
          </div>
          <div id="ghStatus" style="color:var(--muted); font-size:0.9rem;"></div>
        </div>
      </div>
    </div>

    <div class="panel">
      <h3 style="margin:0 0 8px 0">Leaderboard Preview</h3>
      <div class="leaderboard-preview" id="lbPreview"></div>
      <div style="margin-top:12px; color:var(--muted); font-size:0.92rem;">Click the red X to remove an entry from the leaderboard.</div>
    </div>
  </div>
</div>

<!-- Delete overlay that requests a termination reason -->
<div class="overlay-delete" id="deleteOverlay">
  <div class="popup">
    <h3>Delete User</h3>
    <p style="margin:0 0 6px 0; color:var(--muted)">Enter a reason for termination (user will see this on refresh):</p>
    <input type="text" id="delReason" placeholder="Reason for termination">
    <div class="actions" style="margin-top:8px;">
      <button id="confirmDelete" class="btn">Delete</button>
      <button id="cancelDelete" class="btn btn-ghost">Cancel</button>
    </div>
  </div>
</div>

<script>
/*
  submissions.html admin console

  Important notes:
   - This page reads /users.json, /submissions.json, /leaderboard.json, /terminated.json via fetch(GET).
   - If you want to persist changes to the repo, fill in:
       - owner/repo (ghRepo)
       - branch (ghBranch)
       - Personal Access Token (ghToken) with repo scope
     Then click "Save Current Files to Repo" or rely on the "Test GitHub" button.
   - The page includes a simple password gate (client-side) for convenience.
   - If you don't provide a token, changes are kept in-memory and are not saved to the repo.
*/

//////////////////////
// Config paths
//////////////////////
const PATH_USERS = '/users.json';
const PATH_SUBMISSIONS = '/submissions.json';
const PATH_LEADERBOARD = '/leaderboard.json';
const PATH_TERMINATED = '/terminated.json';

//////////////////////
// Admin password (this is only a UI gate)
//////////////////////
const ADMIN_PASSWORD = "spring@53!rç"; // you already had this in previous scripts

//////////////////////
// DOM refs
//////////////////////
const passwordOverlay = document.getElementById('passwordOverlay');
const passInput = document.getElementById('passInput');
const passBtn = document.getElementById('passBtn');
const passError = document.getElementById('passError');
const mainContainer = document.getElementById('mainContainer');
const tbody = document.querySelector('#submissionTable tbody');

const lbPreview = document.getElementById('lbPreview');
const usersListEl = document.getElementById('usersList');
const addUserBtn = document.getElementById('addUserBtn');
const manualUserName = document.getElementById('manualUserName');
const reloadUsersBtn = document.getElementById('reloadUsersBtn');

const deleteOverlay = document.getElementById('deleteOverlay');
const delReasonInput = document.getElementById('delReason');
const confirmDeleteBtn = document.getElementById('confirmDelete');
const cancelDeleteBtn = document.getElementById('cancelDelete');

const ghRepoInput = document.getElementById('ghRepo');
const ghBranchInput = document.getElementById('ghBranch');
const ghTokenInput = document.getElementById('ghToken');
const testGhBtn = document.getElementById('testGh');
const saveGhBtn = document.getElementById('saveGh');
const ghStatusEl = document.getElementById('ghStatus');

let userToDelete = null; // object to delete

// in-memory data
let usersData = [];
let submissionsData = [];
let leaderboardData = [];
let terminatedData = {}; // map username -> { reason, timestamp }

// local helper to avoid caching
function fetchJsonOrDefault(path, defaultVal){
  return fetch(path + '?_=' + Date.now(), {cache:'no-store'}).then(res => {
    if(!res.ok) return defaultVal;
    return res.json().catch(()=>defaultVal);
  }).catch(()=>defaultVal);
}

function escapeHtml(s){ if(!s) return ''; return s.replace(/[&<>"']/g, function(m){ return {'&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;',"'":'&#39;'}[m]; }); }
function extractYouTubeId(url){ if(!url) return null; const regex = /(?:v=|\/embed\/|\.be\/|v\/|vi=)([A-Za-z0-9_-]{6,11})/; const m = url.match(regex); if(m && m[1]) return m[1]; return null; }
async function sha256(message){ const msgBuffer = new TextEncoder().encode(message); const hashBuffer = await crypto.subtle.digest('SHA-256', msgBuffer); const hashArray = Array.from(new Uint8Array(hashBuffer)); return hashArray.map(b=>b.toString(16).padStart(2,'0')).join(''); }

//////////////////////
// GitHub commit helpers (PUT /repos/:owner/:repo/contents/:path)
// - requires: owner/repo, branch, token
// - We'll implement helper to get the existing file sha and then PUT new content
//////////////////////
async function ghGetFileSha(owner, repo, path, branch, token){
  const url = `https://api.github.com/repos/${owner}/${repo}/contents${path.startsWith('/') ? '' : '/'}${path}?ref=${branch}`;
  const res = await fetch(url, { headers: { Authorization: `token ${token}`, Accept: 'application/vnd.github.v3+json' } });
  if(!res.ok) return null;
  const json = await res.json();
  return json.sha;
}

async function ghPutFile(owner, repo, path, branch, token, contentStr, commitMessage){
  // contentStr is the JSON string to save
  const url = `https://api.github.com/repos/${owner}/${repo}/contents${path.startsWith('/') ? '' : '/'}${path}`;
  // get existing sha (if any)
  const getRes = await fetch(`${url}?ref=${branch}`, { headers: { Authorization: `token ${token}`, Accept: 'application/vnd.github.v3+json' }});
  let sha = null;
  if(getRes.ok){
    try{ const js = await getRes.json(); sha = js.sha; } catch(e){}
  }
  const body = {
    message: commitMessage || `Update ${path}`,
    content: btoa(unescape(encodeURIComponent(contentStr))), // base64
    branch
  };
  if(sha) body.sha = sha;
  const putRes = await fetch(url, { method:'PUT', headers:{ Authorization: `token ${token}`, Accept: 'application/vnd.github.v3+json', 'Content-Type':'application/json' }, body: JSON.stringify(body) });
  if(!putRes.ok){
    const txt = await putRes.text();
    throw new Error('GitHub API error: ' + putRes.status + ' ' + txt);
  }
  return await putRes.json();
}

//////////////////////
// Load initial JSONs (read-only)
//////////////////////
async function loadAll(){
  usersData = await fetchJsonOrDefault(PATH_USERS, []);
  submissionsData = await fetchJsonOrDefault(PATH_SUBMISSIONS, []);
  leaderboardData = await fetchJsonOrDefault(PATH_LEADERBOARD, []);
  terminatedData = await fetchJsonOrDefault(PATH_TERMINATED, {});
  if(!Array.isArray(usersData)) usersData = [];
  if(!Array.isArray(submissionsData)) submissionsData = [];
  if(!Array.isArray(leaderboardData)) leaderboardData = [];
  if(typeof terminatedData !== 'object' || terminatedData === null) terminatedData = {};
  loadSubmissions();
  loadUsersPanel();
  loadLeaderboardPreview();
}

passBtn.addEventListener('click', async ()=>{
  const inputHash = await sha256(passInput.value || '');
  const realHash = await sha256(ADMIN_PASSWORD);
  if(inputHash === realHash){
    passwordOverlay.style.display='none';
    mainContainer.style.display='block';
    await loadAll();
  } else {
    passError.style.display='block';
    setTimeout(()=> passError.style.display='none', 1500);
  }
});

/* Load submissions table */
function loadSubmissions(){
  tbody.innerHTML='';
  if(!Array.isArray(submissionsData) || submissionsData.length === 0){
    const tr = document.createElement('tr');
    tr.innerHTML = `<td colspan="6" style="opacity:.8; text-align:center; padding:20px;">No pending submissions.</td>`;
    tbody.appendChild(tr);
    return;
  }
  submissionsData.forEach((sub,i)=>{
    const tr = document.createElement('tr');
    tr.innerHTML = `
      <td>${i+1}</td>
      <td style="max-width:180px;">${escapeHtml(sub.name)}</td>
      <td>${escapeHtml(sub.creator)}</td>
      <td>${escapeHtml(sub.submittedBy || 'Unknown')}</td>
      <td>${sub.youtube ? `<a href="${escapeHtml(sub.youtube)}" target="_blank" style="color:var(--accent1);">Link</a>` : '—'}</td>
      <td>
        <input type="number" min="1" class="rank-input" placeholder="Rank">
        <button class="accept">Approve</button>
        <button class="decline">Decline</button>
      </td>
    `;
    tbody.appendChild(tr);

    // Decline
    tr.querySelector('.decline').addEventListener('click', ()=> {
      submissionsData.splice(i,1);
      loadSubmissions();
      alert('Submission removed (locally). Use "Save Current Files to Repo" to persist changes to GitHub.');
    });

    // Approve
    tr.querySelector('.accept').addEventListener('click', ()=> {
      const rankInput = tr.querySelector('.rank-input');
      const rank = parseInt(rankInput.value);
      if(!rank || rank < 1){ alert('Enter a valid rank number (>=1)'); return; }
      // bump existing entries that are >= rank
      leaderboardData.forEach(entry=>{ if(Number(entry.rank) >= rank) entry.rank = Number(entry.rank) + 1; });
      // push new entry with rank
      leaderboardData.push({ name: sub.name, creator: sub.creator, submittedBy: sub.submittedBy, youtube: sub.youtube, rank });
      leaderboardData.sort((a,b)=>Number(a.rank) - Number(b.rank));
      // remove from submissions
      submissionsData.splice(i,1);
      loadSubmissions();
      loadLeaderboardPreview();
      alert('Approved locally (not yet committed). Use "Save Current Files to Repo" to persist to GitHub.');
    });
  });
}

/* Load users panel */
function loadUsersPanel(){
  usersListEl.innerHTML = '';
  if(usersData.length === 0){
    const e = document.createElement('div'); e.style.color = 'var(--muted)'; e.textContent = 'No users yet.'; usersListEl.appendChild(e); return;
  }

  usersData.forEach(u=>{
    const row = document.createElement('div'); row.className = 'user-row';
    const left = document.createElement('div'); left.style.display='flex'; left.style.flexDirection='column';
    left.innerHTML = `<div class="user-name">${escapeHtml(u.username)}${u.mto ? ' <span style="color:#ffdd55;font-weight:700">MTO</span>':''}</div><small style="color:var(--muted)">#${u.tag || '----'}</small>`;

    const actions = document.createElement('div'); actions.className = 'user-actions';
    const renameBtn = document.createElement('button'); renameBtn.textContent = 'Rename'; renameBtn.style.background = 'linear-gradient(135deg,var(--accent1),var(--accent2))'; renameBtn.style.color='#000';
    const removeBtn = document.createElement('button'); removeBtn.textContent = 'Remove'; removeBtn.style.background = '#ff6b6b'; removeBtn.style.color = '#fff';
    const mtoBtn = document.createElement('button'); mtoBtn.textContent = u.mto ? 'Demote MTO' : 'Promote MTO'; mtoBtn.style.background = u.mto ? '#555':'gold'; mtoBtn.style.color = u.mto ? '#fff' : '#000';

    renameBtn.addEventListener('click', ()=> {
      const newName = prompt('Enter new username for "' + u.username + '"', u.username);
      if(!newName) return;
      if(newName.trim().length < 2){ alert('Username must be at least 2 characters'); return; }
      const existing = usersData.find(x => x.username.toLowerCase() === newName.trim().toLowerCase());
      if(existing && existing.username.toLowerCase() !== u.username.toLowerCase()){ alert('That username is already taken'); return; }
      // perform rename in usersData
      usersData.forEach(uu => { if(uu.username.toLowerCase() === u.username.toLowerCase()){ uu.username = newName.trim(); } });
      // update submissions
      submissionsData.forEach(s => { if(s.submittedBy && s.submittedBy.toLowerCase() === u.username.toLowerCase()) s.submittedBy = newName.trim(); });
      // update leaderboard
      leaderboardData.forEach(e => { if(e.submittedBy && e.submittedBy.toLowerCase() === u.username.toLowerCase()) e.submittedBy = newName.trim(); });
      loadUsersPanel(); loadSubmissions(); loadLeaderboardPreview();
      alert('Renamed locally. Save to GitHub to persist.');
    });

    removeBtn.addEventListener('click', ()=> {
      userToDelete = u;
      delReasonInput.value = '';
      deleteOverlay.style.display = 'flex';
    });

    mtoBtn.addEventListener('click', ()=>{
      usersData.forEach(uu => { if(uu.username.toLowerCase() === u.username.toLowerCase()){ uu.mto = !uu.mto; } });
      loadUsersPanel();
      alert(`Toggled MTO locally for "${u.username}". Save to GitHub to persist.`);
    });

    actions.appendChild(renameBtn); actions.appendChild(removeBtn); actions.appendChild(mtoBtn);
    row.appendChild(left); row.appendChild(actions);
    usersListEl.appendChild(row);
  });
}

/* Delete confirm/cancel */
confirmDeleteBtn.addEventListener('click', ()=>{
  if(!userToDelete) return;
  const reason = delReasonInput.value.trim();
  if(!reason){ alert('Enter a reason'); return; }
  // remove user from usersData (but mark terminated in terminatedData and also set isBanned true if you prefer)
  usersData = usersData.filter(uu => uu.username.toLowerCase() !== userToDelete.username.toLowerCase());
  // set terminated entry
  terminatedData[userToDelete.username] = { reason, timestamp: Date.now() };
  // remove their submissions
  submissionsData = submissionsData.filter(s => !(s.submittedBy && s.submittedBy.toLowerCase() === userToDelete.username.toLowerCase()));
  // remove leaderboard entries they submitted
  leaderboardData = leaderboardData.filter(e => !(e.submittedBy && e.submittedBy.toLowerCase() === userToDelete.username.toLowerCase()));
  deleteOverlay.style.display = 'none';
  userToDelete = null;
  loadUsersPanel(); loadSubmissions(); loadLeaderboardPreview();
  alert('User removed locally and termination reason stored locally. To persist to repo, click "Save Current Files to Repo".');
});
cancelDeleteBtn.addEventListener('click', ()=>{ deleteOverlay.style.display = 'none'; userToDelete = null; });

/* Add user manually (admin) */
addUserBtn.addEventListener('click', async ()=> {
  const name = manualUserName.value.trim();
  if(!name || name.length < 2){ alert('Enter a username (min 2 chars)'); return; }
  if(usersData.find(u => u.username.toLowerCase() === name.toLowerCase())){ alert('That username already exists'); return; }
  const tag = generateTag();
  const password = prompt('Set a password for this account (admin-created). Leave empty to create without password (user cannot login).');
  let hashed = null;
  if(password && password.length > 0) hashed = await sha256(password);
  usersData.push({ username: name, tag, passwordHash: hashed, createdAt: Date.now(), isBanned:false, mto:false });
  manualUserName.value = '';
  loadUsersPanel();
  alert('User added locally. Save to GitHub to persist.');
});
reloadUsersBtn.addEventListener('click', loadAll);

function generateTag(){
  const taken = new Set(usersData.map(u=>u.tag));
  for(let i=1;i<10000;i++){ const t = String(i).padStart(4,'0'); if(!taken.has(t)) return t; }
  return String(Date.now()).slice(-4);
}

/* Load leaderboard preview and allow removal with X */
function loadLeaderboardPreview(){
  lbPreview.innerHTML = '';
  const list = (Array.isArray(leaderboardData) ? leaderboardData : []).map(x=>({...x, rank: Number(x.rank) || 9999})).sort((a,b)=>a.rank-b.rank);
  if(list.length === 0){
    const e = document.createElement('div'); e.style.color='var(--muted)'; e.style.opacity=0.85; e.textContent='No leaderboard entries yet.'; lbPreview.appendChild(e); return;
  }
  list.forEach(entry=>{
    const card = document.createElement('div'); card.className='lb-card';
    const left = document.createElement('div'); left.className='lb-left';
    const ytId = extractYouTubeId(entry.youtube);
    if(ytId){ const iframe = document.createElement('iframe'); iframe.src = `https://www.youtube.com/embed/${ytId}`; iframe.allow='accelerometer; autoplay; clipboard-write; encrypted-media; gyroscope; picture-in-picture'; iframe.allowFullscreen=true; left.appendChild(iframe); } else left.textContent='—';
    const mid = document.createElement('div'); mid.className='lb-mid'; mid.innerHTML = `<div style="display:flex;align-items:center;gap:8px;"><div class="lb-rank">${entry.rank}</div><div class="lb-title">${escapeHtml(entry.name)}</div></div><div class="lb-creator">by ${escapeHtml(entry.creator)} • sent by ${escapeHtml(entry.submittedBy||'Unknown')}</div>`;
    const actions = document.createElement('div'); actions.className='lb-actions';
    const removeBtn = document.createElement('button'); removeBtn.className='remove-btn'; removeBtn.textContent='X'; removeBtn.title='Remove from leaderboard';
    removeBtn.addEventListener('click', ()=> {
      if(!confirm(`Remove "${entry.name}" from leaderboard?`)) return;
      leaderboardData = leaderboardData.filter(e2 => !(e2.name===entry.name && e2.creator===entry.creator && Number(e2.rank)===Number(entry.rank) && e2.youtube===entry.youtube));
      loadLeaderboardPreview();
      alert('Removed locally. Save to GitHub to persist.');
    });
    actions.appendChild(removeBtn);
    card.appendChild(left); card.appendChild(mid); card.appendChild(actions);
    lbPreview.appendChild(card);
  });
}

/* GitHub helpers & UI */
function getGhConfig(){
  const repo = (ghRepoInput.value || '').trim();
  const branch = (ghBranchInput.value || '').trim() || 'main';
  const token = (ghTokenInput.value || '').trim();
  if(!repo) throw new Error('Set owner/repo in GitHub config');
  const [owner, r] = repo.split('/');
  if(!owner || !r) throw new Error('owner/repo format required');
  return { owner, repo: r, branch, token };
}

testGhBtn.addEventListener('click', async ()=>{
  try{
    ghStatusEl.textContent = 'Testing...';
    const cfg = getGhConfig();
    if(!cfg.token){ ghStatusEl.textContent = 'No token provided; will not be able to write.'; return; }
    // Test by trying to get users.json sha (may 404 but that is okay)
    const sha = await ghGetFileSha(cfg.owner, cfg.repo, '/users.json', cfg.branch, cfg.token);
    ghStatusEl.textContent = sha ? 'OK (found file)' : 'OK (no existing file found - will create on save)';
  }catch(e){
    ghStatusEl.textContent = 'Test failed: ' + e.message;
  }
});

// Save current in-memory files to GitHub repo (requires token)
saveGhBtn.addEventListener('click', async ()=>{
  try{
    const cfg = getGhConfig();
    if(!cfg.token){ if(!confirm('No token provided — files will NOT be persisted to GitHub. Proceed locally?')) return; }
    if(!cfg.token){
      alert('No token set. Changes only local. To persist, provide a GitHub token and repo/branch.');
      return;
    }
    ghStatusEl.textContent = 'Saving files to repo...';
    // Save each of the four files
    const files = [
      { path: '/users.json', data: usersData },
      { path: '/submissions.json', data: submissionsData },
      { path: '/leaderboard.json', data: leaderboardData },
      { path: '/terminated.json', data: terminatedData }
    ];
    for(const f of files){
      const str = JSON.stringify(f.data, null, 2);
      const msg = `Update ${f.path} via admin UI`;
      await ghPutFile(cfg.owner, cfg.repo, f.path, cfg.branch, cfg.token, str, msg);
    }
    ghStatusEl.textContent = 'Saved successfully.';
    alert('Saved to GitHub successfully.');
  }catch(e){
    ghStatusEl.textContent = 'Save failed: ' + e.message;
    alert('Save failed: ' + e.message);
  }
});

/* Boot */
document.addEventListener('DOMContentLoaded', ()=>{
  // Nothing until admin logs in via password overlay
});

</script>
</body>
</html>
