<!doctype html>
<html lang="en">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width, initial-scale=1" />
<title>Kacper's List</title>
<style>
  :root{ --accent1:#53baff; --accent2:#6be3ff; --glass-bg: rgba(255,255,255,0.10); --card-bg: rgba(255,255,255,0.04); --muted: rgba(255,255,255,0.6); }
  html, body { height:100%; margin:0; font-family:'Segoe UI', Roboto, Helvetica, Arial, sans-serif; background:#000; color:#fff; -webkit-font-smoothing:antialiased; -moz-osx-font-smoothing:grayscale; }
  .bg { position:relative; min-height:100%; display:grid; place-items:center; overflow:hidden; }
  .glass { position:relative; z-index:5; margin:40px; width:calc(100% - 80px); height:calc(100% - 80px); max-width:1400px; max-height:1000px; padding:28px; background:var(--glass-bg); backdrop-filter: blur(10px) saturate(120%); border-radius:24px; border:1px solid rgba(255,255,255,0.06); box-shadow:0 10px 40px rgba(0,0,0,0.6); display:flex; flex-direction:column; }
  .top-bar { display:flex; align-items:center; justify-content:space-between; gap:12px; margin-bottom:12px; }
  .title { font-size:1.5rem; font-weight:700; letter-spacing:0.2px; }
  .inner-rect { flex:1; background:rgba(255,255,255,0.03); border-radius:18px; backdrop-filter: blur(6px); padding:20px; overflow:auto; display:flex; flex-direction:column; align-items:center; gap:18px; }
  .leaderboard-frame { width:100%; max-width:1100px; height:100%; background:rgba(0,0,0,0.18); border-radius:12px; padding:18px; box-sizing:border-box; display:flex; flex-direction:column; align-items:center; gap:12px; overflow:auto; }
  .card { width: calc(100% - 40px); max-width:1000px; background:var(--card-bg); border-radius:12px; display:flex; gap:14px; padding:12px; align-items:center; position:relative; box-shadow: 0 6px 18px rgba(0,0,0,0.5); }
  .card-left { min-width:240px; max-width:360px; width:34%; height:140px; display:flex; align-items:center; justify-content:center; background:rgba(0,0,0,0.35); border-radius:8px; overflow:hidden; }
  .card-left iframe { width:100%; height:100%; border:0; display:block; }
  .card-mid { flex:1; display:flex; flex-direction:column; gap:6px; padding-right:8px; }
  .rank-row { display:flex; align-items:center; gap:12px; }
  .rank { font-size:2rem; font-weight:800; color:var(--accent1); min-width:68px; text-align:center; }
  .level-name { font-size:1.05rem; font-weight:700; word-break:break-word; }
  .creator { font-size:0.95rem; color:var(--muted); }
  .card-top-right { position:absolute; top:10px; right:12px; font-weight:600; font-size:0.9rem; color:var(--muted); background: rgba(255,255,255,0.03); padding:6px 8px; border-radius:8px; }
  .btn { padding:10px 14px; border-radius:10px; border:none; cursor:pointer; font-weight:700; background:linear-gradient(135deg,var(--accent1),var(--accent2)); color:#fff; }
  .btn.ghost { background:transparent; border:1px solid rgba(255,255,255,0.06); }
  .overlay { position:fixed; inset:0; display:flex; align-items:center; justify-content:center; z-index:20; background:rgba(0,0,0,0.72); opacity:0; pointer-events:none; transition:opacity .25s ease; }
  .overlay.active { opacity:1; pointer-events:auto; }
  .popup { background: rgba(255,255,255,0.12); backdrop-filter: blur(16px); border-radius:20px; border:1px solid rgba(255,255,255,0.15); padding:20px; width:420px; max-width:94%; color:#fff; display:flex; flex-direction:column; gap:10px; box-shadow:0 12px 40px rgba(0,0,0,0.5); transform:translateY(20px); transition:transform .3s; }
  .popup input[type=text], .popup input[type=url], .popup input[type=number] { padding:10px 12px; border-radius:10px; border:none; background:rgba(255,255,255,0.06); color:#fff; outline:none; }
  .error-msg { color:#ff6b6b; font-size:0.9rem; display:none; }
  .user-info { position:absolute; bottom:10px; left:10px; display:flex; align-items:center; gap:10px; font-size:0.95rem; z-index:30; background: rgba(0,0,0,0.35); padding:8px 10px; border-radius:12px; backdrop-filter: blur(4px); border:1px solid rgba(255,255,255,0.04); }
  .user-info img { width:36px; height:36px; border-radius:50%; }
  .user-info .name { font-weight:700; margin-left:8px; }
  .user-info .small-actions { display:flex; gap:6px; align-items:center; margin-left:8px; }
  .user-info .small-actions button { padding:6px 8px; font-size:0.85rem; background:transparent; border:1px solid rgba(255,255,255,0.06); color:inherit; border-radius:8px; }
  @media (max-width:800px){ .card { flex-direction:column; align-items:flex-start; height:auto; } .card-left{ width:100%; height:160px; } .rank { font-size:1.6rem; min-width:48px; } .card-top-right{ position:static; align-self:flex-end; margin-left:auto; } }
</style>
</head>
<body>
<div class="bg">
  <div class="glass">
    <div class="top-bar">
      <div class="title">Kacper's List — Leaderboard</div>
      <div style="display:flex; gap:10px; align-items:center;">
        <button class="btn" id="openPopup">Submit Hardest</button>
        <a href="/public/submissions.html" class="btn btn-ghost" style="text-decoration:none; color:inherit;">Submissions</a>
        <button class="btn" id="discordLoginBtn">Login with Discord</button>
      </div>
    </div>

    <div class="inner-rect">
      <div class="leaderboard-frame" id="leaderboardContainer">
        <!-- Cards injected here -->
      </div>
    </div>
  </div>
</div>

<!-- Submit Popup -->
<div class="overlay" id="submitOverlay">
  <div class="popup">
    <h3>Submit a Level</h3>
    <input type="text" id="subName" placeholder="Level Name">
    <div class="error-msg" id="errName">Level name required</div>
    <input type="text" id="subCreator" placeholder="Level Creator">
    <div class="error-msg" id="errCreator">Creator required</div>
    <input type="url" id="subYT" placeholder="YouTube Link (https://...)">
    <div class="error-msg" id="errYT">Valid YouTube link required</div>

    <div class="actions">
      <button class="btn" id="confirmSubmit">Submit</button>
    </div>
  </div>
</div>

<!-- Termination popup for banned users -->
<div class="overlay" id="terminatedOverlay">
  <div class="popup" style="width:420px;">
    <h3>Your account got terminated!</h3>
    <div id="terminatedReason" style="color:var(--muted)"></div>
    <div style="display:flex; justify-content:flex-end; gap:8px; margin-top:8px;">
      <button class="btn" id="termLogout">Log out</button>
    </div>
  </div>
</div>

<!-- bottom-left user info (discord avatar + name) -->
<div class="user-info" id="userInfo" style="display:none;">
  <img id="userAvatar" src="" alt="pfp">
  <div style="display:flex; flex-direction:column;">
    <span class="name" id="userName">User</span>
    <small style="color:var(--muted)" id="userTag"></small>
  </div>
  <div class="small-actions">
    <button id="logoutBtn">Logout</button>
  </div>
</div>

<script>
/*
  public/index.html
  - Uses /api/* endpoints on same origin to get shared JSON data.
  - Login via /auth/discord -> server handles token exchange and session.
*/

const API_BASE = '/api';

function extractYouTubeId(url){
  if(!url) return null;
  const regex = /(?:v=|\/embed\/|\.be\/|v\/|vi=)([A-Za-z0-9_-]{6,11})/;
  const m = url.match(regex);
  if(m && m[1]) return m[1];
  return null;
}
function el(q){ return document.querySelector(q); }
function escapeHtml(s){ if(!s) return ''; return s.replace(/[&<>"']/g, function(m){ return {'&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;',"'":'&#39;'}[m]; }); }

const submitOverlay = el('#submitOverlay');
const openPopup = el('#openPopup');
const confirmSubmit = el('#confirmSubmit');
const leaderboardContainer = el('#leaderboardContainer');

const userInfoBox = el('#userInfo');
const userNameEl = el('#userName');
const userTagEl = el('#userTag');
const userAvatarEl = el('#userAvatar');
const logoutBtn = el('#logoutBtn');

const discordLoginBtn = el('#discordLoginBtn');

const terminatedOverlay = el('#terminatedOverlay');
const terminatedReasonEl = el('#terminatedReason');
const termLogoutBtn = el('#termLogout');

// show/hide helpers
function show(el){ el.classList.add('active'); el.style.display='flex'; }
function hide(el){ el.classList.remove('active'); el.style.display='none'; }

// Boot: fetch me, leaderboard
async function boot(){
  // fetch /api/me to determine session
  try{
    const meResp = await fetch(API_BASE + '/me', { credentials: 'include' });
    const me = meResp.ok ? await meResp.json() : null;
    if(me){
      if(me.isBanned){
        terminatedReasonEl.textContent = me.banReason || 'No reason provided';
        show(terminatedOverlay);
        return;
      }
      setUserUI(me);
    } else {
      clearUserUI();
    }
  } catch(e){
    console.error('me fetch error', e);
    clearUserUI();
  }

  await loadLeaderboard();
}

function setUserUI(me){
  if(!me) return clearUserUI();
  userInfoBox.style.display='flex';
  userNameEl.textContent = me.displayName || me.username || 'User';
  userTagEl.textContent = me.tag ? ('#' + me.tag) : (me.discordId ? ('#' + me.discordId) : '');
  if(me.avatar){
    // discord avatar URL (cdn). Discord avatar is hashed; construct URL.
    // If avatar is a full URL (we store), use it directly; else build url via CDN
    if(me.avatar.startsWith('http')) userAvatarEl.src = me.avatar;
    else userAvatarEl.src = `https://cdn.discordapp.com/avatars/${me.discordId}/${me.avatar}.png`;
  } else {
    userAvatarEl.src = '';
    userAvatarEl.style.display = me.avatar ? 'block' : 'none';
  }
  // hide login button
  discordLoginBtn.style.display = 'none';
}

function clearUserUI(){
  userInfoBox.style.display='none';
  discordLoginBtn.style.display = 'inline-block';
}

// load leaderboard (approved entries)
async function loadLeaderboard(){
  leaderboardContainer.innerHTML = '';
  try{
    const resp = await fetch(API_BASE + '/leaderboard', { credentials: 'include' });
    if(!resp.ok) throw new Error('no leaderboard');
    const data = await resp.json();
    const list = (Array.isArray(data) ? data : []).map(x => ({...x, rank: Number(x.rank) || 9999})).sort((a,b)=>a.rank-b.rank);

    if(list.length === 0){
      const empty = document.createElement('div');
      empty.style.opacity = 0.7; empty.style.color = 'var(--muted)'; empty.style.marginTop = '20px'; empty.style.textAlign = 'center';
      empty.textContent = 'No leaderboard entries yet — be first to submit (admins must approve).';
      leaderboardContainer.appendChild(empty);
      return;
    }

    list.forEach(item => {
      const card = document.createElement('div'); card.className='card';
      const left = document.createElement('div'); left.className='card-left';
      const ytId = extractYouTubeId(item.youtube);
      if(ytId){
        const iframe = document.createElement('iframe');
        iframe.src = `https://www.youtube.com/embed/${ytId}`;
        iframe.allow = 'accelerometer; autoplay; clipboard-write; encrypted-media; gyroscope; picture-in-picture';
        iframe.allowFullscreen = true;
        left.appendChild(iframe);
      } else left.textContent = 'No video';

      const mid = document.createElement('div'); mid.className='card-mid';
      const rankRow = document.createElement('div'); rankRow.className='rank-row';
      const rankEl = document.createElement('div'); rankEl.className='rank'; rankEl.textContent = item.rank || '-';
      const nameEl = document.createElement('div'); nameEl.className='level-name'; nameEl.textContent = item.name || 'Unknown level';
      rankRow.appendChild(rankEl); rankRow.appendChild(nameEl);
      const creator = document.createElement('div'); creator.className='creator'; creator.textContent = 'by ' + (item.creator || 'Unknown');
      mid.appendChild(rankRow); mid.appendChild(creator);

      const topRight = document.createElement('div'); topRight.className='card-top-right';
      topRight.textContent = 'sent by ' + (item.submittedBy || 'Unknown');

      card.appendChild(left); card.appendChild(mid); card.appendChild(topRight);
      leaderboardContainer.appendChild(card);
    });

  }catch(e){
    console.error('loadLeaderboard error', e);
    const empty = document.createElement('div');
    empty.style.opacity = 0.7; empty.style.color = 'var(--muted)'; empty.style.marginTop = '20px'; empty.style.textAlign = 'center';
    empty.textContent = 'Could not load leaderboard.';
    leaderboardContainer.appendChild(empty);
  }
}

/* Submit flow */
openPopup.addEventListener('click', async () => {
  // require login
  const meResp = await fetch(API_BASE + '/me', { credentials: 'include' });
  const me = meResp.ok ? await meResp.json() : null;
  if(!me){
    // redirect to Discord login
    window.location.href = '/auth/discord';
    return;
  }
  show(submitOverlay);
});

confirmSubmit.addEventListener('click', async () => {
  const name = document.getElementById('subName').value.trim();
  const creator = document.getElementById('subCreator').value.trim();
  const yt = document.getElementById('subYT').value.trim();

  const errName = document.getElementById('errName');
  const errCreator = document.getElementById('errCreator');
  const errYT = document.getElementById('errYT');

  let ok = true;
  if(!name){ errName.style.display='block'; ok=false; } else errName.style.display='none';
  if(!creator){ errCreator.style.display='block'; ok=false; } else errCreator.style.display='none';
  if(yt && !/^https?:\/\//.test(yt)){ errYT.style.display='block'; errYT.textContent='Valid YouTube link required'; ok=false; } else errYT.style.display='none';

  if(!ok) return;

  // send to server
  const resp = await fetch(API_BASE + '/submissions', {
    method: 'POST',
    credentials: 'include',
    headers: { 'Content-Type': 'application/json' },
    body: JSON.stringify({ name, creator, youtube: yt })
  });
  if(resp.ok){
    hide(submitOverlay);
    document.getElementById('subName').value='';
    document.getElementById('subCreator').value='';
    document.getElementById('subYT').value='';
    alert('Submission saved. Admins must approve it to appear on the leaderboard.');
  } else {
    const js = await resp.json().catch(()=>({}));
    alert('Submission failed: ' + (js.error || 'unknown'));
  }
});

/* Discord login button */
discordLoginBtn.addEventListener('click', () => {
  // redirect to server endpoint which takes care of Discord OAuth
  window.location.href = '/auth/discord';
});

/* Logout */
logoutBtn.addEventListener('click', async () => {
  const r = await fetch('/api/logout', { method: 'POST', credentials: 'include' });
  if (r.ok) {
    location.reload();
  } else {
    alert('Logout failed');
  }
});
termLogoutBtn.addEventListener('click', async () => {
  await fetch('/api/logout', { method: 'POST', credentials: 'include' });
  window.location.href = '/public/index.html';
});

// On load
document.addEventListener('DOMContentLoaded', () => {
  boot();
});

</script>
</body>
</html>
