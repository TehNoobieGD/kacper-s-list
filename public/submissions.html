<!doctype html>
<html lang="en">
<head>
<meta charset="utf-8">
<meta name="viewport" content="width=device-width, initial-scale=1">
<title>Kacper's List Submissions (Admin)</title>
<style>
  :root{ --accent1:#53baff; --accent2:#6be3ff; --muted:rgba(255,255,255,0.65); }
  body{ margin:0; font-family:'Segoe UI',Roboto,Helvetica,Arial; background:#111; color:#fff; display:flex; justify-content:center; align-items:flex-start; min-height:100vh; padding:28px; box-sizing:border-box;}
  .container{ width:95%; max-width:1300px; background: rgba(255,255,255,0.03); padding:20px; border-radius:16px; backdrop-filter: blur(8px); border:1px solid rgba(255,255,255,0.04); box-shadow: 0 10px 30px rgba(0,0,0,0.6);}
  h1{ text-align:center; margin:8px 0 18px 0; }
  .grid{ display:grid; grid-template-columns: 1fr 320px 300px; gap:18px; align-items:start; }
  .panel{ background: rgba(0,0,0,0.25); padding:12px; border-radius:12px; }
  .sub-table{ width:100%; border-collapse:collapse; }
  .sub-table th, .sub-table td{ padding:10px; border-bottom:1px solid rgba(255,255,255,0.05); text-align:left; vertical-align:middle; }
  .sub-table th{ font-weight:700; background: rgba(255,255,255,0.02); }
  .rank-input{ width:70px; padding:6px 8px; border-radius:8px; border:none; outline:none; }
  button{ padding:8px 10px; border-radius:8px; border:none; cursor:pointer; font-weight:700; }
  .accept{ background:#4CAF50; color:#fff; }
  .decline{ background:#F44336; color:#fff; }
  .leaderboard-preview{ display:flex; flex-direction:column; gap:10px; max-height:420px; overflow:auto; }
  .lb-card{ background: rgba(255,255,255,0.03); border-radius:10px; padding:8px; display:flex; gap:8px; align-items:center; position:relative; }
  .lb-left{ min-width:110px; max-width:140px; height:80px; border-radius:6px; overflow:hidden; background:rgba(0,0,0,0.3); display:flex; align-items:center; justify-content:center; }
  .lb-mid{ flex:1; display:flex; flex-direction:column; gap:6px; }
  .lb-rank{ font-size:1.2rem; font-weight:800; color:var(--accent1); min-width:48px; }
  .lb-title{ font-weight:700; }
  .lb-creator{ color:var(--muted); font-size:0.95rem; }
  .lb-actions{ position:absolute; top:8px; right:8px; display:flex; gap:6px; }
  .remove-btn{ background:#ff6b6b; color:#fff; border-radius:8px; padding:6px 8px; cursor:pointer; border:none; font-weight:700; }

  .password-overlay{ position:fixed; inset:0; background:rgba(0,0,0,0.88); z-index:60; display:flex; align-items:center; justify-content:center; flex-direction:column; gap:10px; }
  .password-overlay input{ padding:12px 14px; border-radius:10px; border:none; outline:none; width:260px; }
  .password-overlay button{ padding:10px 18px; border-radius:10px; border:none; cursor:pointer; background:linear-gradient(135deg,var(--accent1),var(--accent2)); color:#fff; font-weight:700; }
  .error-msg{ color:#ff6b6b; display:none; }

  .users-list { display:flex; flex-direction:column; gap:8px; max-height:420px; overflow:auto; }
  .user-row { display:flex; gap:8px; align-items:center; justify-content:space-between; background: rgba(255,255,255,0.02); padding:8px; border-radius:8px; }
  .user-name { font-weight:700; }
  .user-actions { display:flex; gap:6px; }

  .overlay-delete { position:fixed; inset:0; display:none; align-items:center; justify-content:center; z-index:80; background:rgba(0,0,0,0.6); }
  .overlay-delete .popup { width:420px; }

  .github-config{ display:flex; gap:8px; margin-top:12px; flex-direction:column; }
  .github-config input{ padding:8px; border-radius:8px; border:none; background:rgba(255,255,255,0.03); color:#fff; }

  @media (max-width:1100px){ .grid{ grid-template-columns: 1fr 1fr; } }
  @media (max-width:780px){ .grid{ grid-template-columns: 1fr; } }
</style>
</head>
<body>
<div class="password-overlay" id="passwordOverlay">
  <h2 style="margin:0">Admin gate</h2>
  <p style="color:var(--muted); margin:0 0 8px 0;">Sign in with Discord (admins only) — click below:</p>
  <div style="display:flex; gap:8px;">
    <a class="btn" href="/auth/discord">Login with Discord</a>
    <button id="continueAnon" class="btn btn-ghost">Continue (read-only)</button>
  </div>
  <div class="error-msg" id="passError">Admin access required for edits</div>
</div>

<div class="container" id="mainContainer" style="display:block;">
  <h1>All Submissions & Leaderboard Manager</h1>
  <div style="margin-bottom:10px; color:var(--muted);">Use your Discord admin account to make edits (approve/decline/delete). Changes are persisted on the server; if the server has GitHub configured it will also push to the repo.</div>
  <div class="grid">
    <div class="panel" style="min-height:380px;">
      <h3 style="margin:0 0 8px 0">Submissions</h3>
      <table class="sub-table" id="submissionTable">
        <thead>
          <tr><th>#</th><th>Level</th><th>Creator</th><th>Submitted by</th><th>YT</th><th>Actions</th></tr>
        </thead>
        <tbody></tbody>
      </table>
    </div>

    <div class="panel">
      <h3 style="margin:0 0 8px 0">Users</h3>
      <div style="margin-bottom:8px;">
        <input type="text" id="manualUserName" placeholder="Add user (username)" style="width:100%; padding:8px; border-radius:8px; border:none; background:rgba(255,255,255,0.03); color:#fff;">
        <div style="display:flex; gap:8px; margin-top:8px;">
          <button id="addUserBtn" style="flex:1; background:linear-gradient(135deg,var(--accent1),var(--accent2)); color:#fff;">Add User</button>
          <button id="reloadUsersBtn" style="flex:1; background:transparent; border:1px solid rgba(255,255,255,0.06);">Reload</button>
        </div>
      </div>
      <div class="users-list" id="usersList"></div>

      <div style="margin-top:12px;">
        <h4>Server GitHub status</h4>
        <div id="serverStatus" style="color:var(--muted); font-size:0.9rem;"></div>
      </div>
    </div>

    <div class="panel">
      <h3 style="margin:0 0 8px 0">Leaderboard Preview</h3>
      <div class="leaderboard-preview" id="lbPreview"></div>
      <div style="margin-top:12px; color:var(--muted); font-size:0.92rem;">Click the red X to remove an entry from the leaderboard.</div>
    </div>
  </div>
</div>

<!-- Delete overlay that requests a termination reason -->
<div class="overlay-delete" id="deleteOverlay">
  <div class="popup">
    <h3>Delete User</h3>
    <p style="margin:0 0 6px 0; color:var(--muted)">Enter a reason for termination (user will see this on refresh):</p>
    <input type="text" id="delReason" placeholder="Reason for termination">
    <div class="actions" style="margin-top:8px;">
      <button id="confirmDelete" class="btn">Delete</button>
      <button id="cancelDelete" class="btn btn-ghost">Cancel</button>
    </div>
  </div>
</div>

<script>
/* Admin console client talks to server endpoints */
const api = {
  getSession: () => fetch('/api/session', { credentials: 'same-origin' }).then(r=>r.json()).catch(()=>({user:null})),
  getUsers: () => fetch('/api/users?_=' + Date.now(), { cache: 'no-store' }).then(r=>r.json()).catch(()=>[]),
  getSubmissions: () => fetch('/api/submissions?_=' + Date.now(), { cache: 'no-store' }).then(r=>r.json()).catch(()=>[]),
  getLeaderboard: () => fetch('/api/leaderboard?_=' + Date.now(), { cache: 'no-store' }).then(r=>r.json()).catch(()=>[]),
  post: (path, body) => fetch(path, { method:'POST', headers:{'Content-Type':'application/json'}, credentials:'same-origin', body: JSON.stringify(body)}).then(r=>r.json())
};

function escapeHtml(s){ if(!s) return ''; return s.replace(/[&<>"']/g, function(m){ return {'&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;',"'":'&#39;'}[m]; }); }
function extractYouTubeId(url){ if(!url) return null; const regex = /(?:v=|\/embed\/|\.be\/|v\/|vi=)([A-Za-z0-9_-]{6,11})/; const m = url.match(regex); if(m && m[1]) return m[1]; return null; }

const submissionTbody = document.querySelector('#submissionTable tbody');
const lbPreview = document.getElementById('lbPreview');
const usersListEl = document.getElementById('usersList');
const addUserBtn = document.getElementById('addUserBtn');
const manualUserName = document.getElementById('manualUserName');
const reloadUsersBtn = document.getElementById('reloadUsersBtn');

const deleteOverlay = document.getElementById('deleteOverlay');
const delReasonInput = document.getElementById('delReason');
const confirmDeleteBtn = document.getElementById('confirmDelete');
const cancelDeleteBtn = document.getElementById('cancelDelete');

let userToDelete = null;
let sessionData = null;

async function boot(){
  sessionData = await api.getSession();
  if(!sessionData.user || !sessionData.isAdmin){
    // show message to log in with Discord and ensure admin access
    document.getElementById('serverStatus').textContent = 'You are not signed in as admin. Click "Login with Discord" (top) to sign in as admin. Editing will fail if you are not admin.';
    // still load read-only
  } else {
    document.getElementById('serverStatus').textContent = `Signed in as ${sessionData.user.username} (admin)`;
    document.getElementById('passwordOverlay').style.display = 'none';
  }
  await loadAll();
}

async function loadAll(){
  await loadSubmissions();
  await loadUsers();
  await loadLeaderboardPreview();
}

async function loadSubmissions(){
  submissionTbody.innerHTML = '';
  const submissions = await api.getSubmissions();
  if(!submissions || submissions.length === 0){
    const tr = document.createElement('tr');
    tr.innerHTML = `<td colspan="6" style="opacity:.8; text-align:center; padding:20px;">No pending submissions.</td>`;
    submissionTbody.appendChild(tr);
    return;
  }
  submissions.forEach((sub, i) => {
    const tr = document.createElement('tr');
    tr.innerHTML = `
      <td>${i+1}</td>
      <td style="max-width:180px;">${escapeHtml(sub.name)}</td>
      <td>${escapeHtml(sub.creator)}</td>
      <td>${escapeHtml(sub.submittedBy || 'Unknown')}</td>
      <td>${sub.youtube ? `<a href="${escapeHtml(sub.youtube)}" target="_blank" style="color:var(--accent1);">Link</a>` : '—'}</td>
      <td>
        <input type="number" min="1" class="rank-input" placeholder="Rank" id="rank-${sub.id}">
        <button class="accept">Approve</button>
        <button class="decline">Decline</button>
      </td>
    `;
    submissionTbody.appendChild(tr);

    tr.querySelector('.decline').addEventListener('click', async ()=>{
      if(!confirm('Decline this submission?')) return;
      const resp = await api.post('/api/admin/decline', { submissionId: sub.id });
      if(resp && resp.ok){
        alert('Declined.');
        await loadSubmissions();
      } else {
        alert(resp.error || 'Failed (admin only)');
      }
    });

    tr.querySelector('.accept').addEventListener('click', async ()=>{
      const rankVal = document.getElementById(`rank-${sub.id}`).value;
      const rank = Number(rankVal);
      if(!rank || rank < 1){ alert('Enter a valid rank (>=1)'); return; }
      const resp = await api.post('/api/admin/approve', { submissionId: sub.id, rank });
      if(resp && resp.ok){
        alert('Approved.');
        await loadSubmissions();
        await loadLeaderboardPreview();
      } else {
        alert(resp.error || 'Failed (admin only)');
      }
    });
  });
}

async function loadUsers(){
  usersListEl.innerHTML = '';
  const users = await api.getUsers();
  if(!users || users.length === 0){
    usersListEl.innerHTML = `<div style="color:var(--muted)">No users yet.</div>`;
    return;
  }
  users.forEach(u => {
    const row = document.createElement('div');
    row.className = 'user-row';
    row.innerHTML = `<div style="display:flex;flex-direction:column;"><div class="user-name">${escapeHtml(u.username)}${u.mto ? ' <span style="color:#ffdd55;font-weight:700">MTO</span>':''}</div><small style="color:var(--muted)">#${u.tag || '----'}</small></div>`;
    const actions = document.createElement('div');
    actions.className = 'user-actions';
    const renameBtn = document.createElement('button'); renameBtn.textContent = 'Rename'; renameBtn.style.background='linear-gradient(135deg,var(--accent1),var(--accent2))'; renameBtn.style.color='#000';
    const removeBtn = document.createElement('button'); removeBtn.textContent = 'Remove'; removeBtn.style.background='#ff6b6b'; removeBtn.style.color='#fff';
    const mtoBtn = document.createElement('button'); mtoBtn.textContent = u.mto ? 'Demote MTO':'Promote MTO'; mtoBtn.style.background = u.mto ? '#555':'gold'; mtoBtn.style.color = u.mto ? '#fff':'#000';
    renameBtn.addEventListener('click', async ()=> {
      const newName = prompt('New username for ' + u.username, u.username);
      if(!newName) return;
      // client-side rename happens by calling admin endpoint add/delete? To keep it simple, we use delete + add flow
      alert('Rename: please remove and re-add with new name (or implement rename server endpoint). For now, implement via remove+add manually.');
    });
    removeBtn.addEventListener('click', ()=> {
      userToDelete = u;
      delReasonInput.value = '';
      deleteOverlay.style.display = 'flex';
    });
    mtoBtn.addEventListener('click', async ()=> {
      // toggle locally by calling add-user with mto? Simpler: ask admin to edit users.json via server commit API — not implemented here.
      alert('Toggle MTO: not implemented in UI. Use GitHub file edits or extend server.');
    });
    actions.appendChild(renameBtn); actions.appendChild(removeBtn); actions.appendChild(mtoBtn);
    row.appendChild(actions);
    usersListEl.appendChild(row);
  });
}

confirmDeleteBtn.addEventListener('click', async ()=>{
  if(!userToDelete) return;
  const reason = delReasonInput.value.trim();
  if(!reason){ alert('Enter a reason'); return; }
  const resp = await api.post('/api/admin/delete-user', { username: userToDelete.username, reason });
  if(resp && resp.ok){
    alert('User removed.');
    userToDelete = null;
    deleteOverlay.style.display = 'none';
    await loadAll();
  } else {
    alert(resp.error || 'Failed (admin only)');
  }
});
cancelDeleteBtn.addEventListener('click', ()=> { deleteOverlay.style.display = 'none'; userToDelete = null; });

addUserBtn.addEventListener('click', async ()=> {
  const name = manualUserName.value.trim();
  if(!name || name.length < 2){ alert('Enter username (min 2 chars)'); return; }
  const resp = await api.post('/api/admin/add-user', { username: name, mto: false });
  if(resp && resp.ok){
    manualUserName.value = '';
    await loadUsers();
    alert('Added locally (persisted by server).');
  } else {
    alert(resp.error || 'Failed (admin only)');
  }
});
reloadUsersBtn.addEventListener('click', loadAll);

async function loadLeaderboardPreview(){
  lbPreview.innerHTML = '';
  const lb = await api.getLeaderboard();
  const list = Array.isArray(lb) ? lb.slice().sort((a,b)=> Number(a.rank||9999)-Number(b.rank||9999)) : [];
  if(list.length === 0){ lbPreview.innerHTML = `<div style="color:var(--muted)">No leaderboard entries.</div>`; return; }
  list.forEach(entry => {
    const card = document.createElement('div'); card.className='lb-card';
    const left = document.createElement('div'); left.className='lb-left';
    const ytId = extractYouTubeId(entry.youtube);
    if(ytId){
      const iframe = document.createElement('iframe'); iframe.src = `https://www.youtube.com/embed/${ytId}`; iframe.allow='accelerometer; autoplay; clipboard-write; encrypted-media; gyroscope; picture-in-picture'; iframe.allowFullscreen=true;
      left.appendChild(iframe);
    } else left.textContent='—';
    const mid = document.createElement('div'); mid.className='lb-mid';
    mid.innerHTML = `<div style="display:flex;align-items:center;gap:8px;"><div class="lb-rank">${entry.rank}</div><div class="lb-title">${escapeHtml(entry.name)}</div></div><div class="lb-creator">by ${escapeHtml(entry.creator)} • sent by ${escapeHtml(entry.submittedBy||'Unknown')}</div>`;
    const actions = document.createElement('div'); actions.className='lb-actions';
    const removeBtn = document.createElement('button'); removeBtn.className='remove-btn'; removeBtn.textContent='X';
    removeBtn.addEventListener('click', async ()=> {
      if(!confirm('Remove from leaderboard?')) return;
      // Removing leaderboard entries not implemented as dedicated endpoint; we can call approve/decline? For now call admin delete-user for removing entries by user or implement a generic delete endpoint on server.
      alert('Use server or extend admin endpoint to remove leaderboard entries.');
    });
    actions.appendChild(removeBtn);
    card.appendChild(left); card.appendChild(mid); card.appendChild(actions);
    lbPreview.appendChild(card);
  });
}

document.addEventListener('DOMContentLoaded', boot);
</script>
</body>
</html>
