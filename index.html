<!doctype html>
<html lang="en">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width, initial-scale=1" />
<title>Kacper's List</title>
<style>
  /* (same styling as you provided) */
  :root{ --accent1:#53baff; --accent2:#6be3ff; --glass-bg: rgba(255,255,255,0.10); --card-bg: rgba(255,255,255,0.04); --muted: rgba(255,255,255,0.6); }
  html, body { height:100%; margin:0; font-family:'Segoe UI', Roboto, Helvetica, Arial, sans-serif; background:#000; color:#fff; -webkit-font-smoothing:antialiased; -moz-osx-font-smoothing:grayscale; }
  .bg { position:relative; min-height:100%; display:grid; place-items:center; overflow:hidden; }
  .glass { position:relative; z-index:5; margin:40px; width:calc(100% - 80px); height:calc(100% - 80px); max-width:1400px; max-height:1000px; padding:28px; background:var(--glass-bg); backdrop-filter: blur(10px) saturate(120%); border-radius:24px; border:1px solid rgba(255,255,255,0.06); box-shadow:0 10px 40px rgba(0,0,0,0.6); display:flex; flex-direction:column; }
  .top-bar { display:flex; align-items:center; justify-content:space-between; gap:12px; margin-bottom:12px; }
  .title { font-size:1.5rem; font-weight:700; letter-spacing:0.2px; }
  .inner-rect { flex:1; background:rgba(255,255,255,0.03); border-radius:18px; backdrop-filter: blur(6px); padding:20px; overflow:auto; display:flex; flex-direction:column; align-items:center; gap:18px; }
  .leaderboard-frame { width:100%; max-width:1100px; height:100%; background:rgba(0,0,0,0.18); border-radius:12px; padding:18px; box-sizing:border-box; display:flex; flex-direction:column; align-items:center; gap:12px; overflow:auto; }
  .card { width: calc(100% - 40px); max-width:1000px; background:var(--card-bg); border-radius:12px; display:flex; gap:14px; padding:12px; align-items:center; position:relative; box-shadow: 0 6px 18px rgba(0,0,0,0.5); }
  .card-left { min-width:240px; max-width:360px; width:34%; height:140px; display:flex; align-items:center; justify-content:center; background:rgba(0,0,0,0.35); border-radius:8px; overflow:hidden; }
  .card-mid { flex:1; display:flex; flex-direction:column; gap:6px; padding-right:8px; }
  .rank-row { display:flex; align-items:center; gap:12px; }
  .rank { font-size:2rem; font-weight:800; color:var(--accent1); min-width:68px; text-align:center; }
  .level-name { font-size:1.05rem; font-weight:700; word-break:break-word; }
  .creator { font-size:0.95rem; color:var(--muted); }
  .card-top-right { position:absolute; top:10px; right:12px; font-weight:600; font-size:0.9rem; color:var(--muted); background: rgba(255,255,255,0.03); padding:6px 8px; border-radius:8px; }
  .btn { padding:10px 14px; border-radius:10px; border:none; cursor:pointer; font-weight:700; background:linear-gradient(135deg,var(--accent1),var(--accent2)); color:#fff; }
  .btn.ghost { background:transparent; border:1px solid rgba(255,255,255,0.06); }
  .overlay { position:fixed; inset:0; display:flex; align-items:center; justify-content:center; z-index:20; background:rgba(0,0,0,0.72); opacity:0; pointer-events:none; transition:opacity .25s ease; }
  .overlay.active { opacity:1; pointer-events:auto; }
  .popup { background: rgba(255,255,255,0.12); backdrop-filter: blur(16px); border-radius:20px; border:1px solid rgba(255,255,255,0.15); padding:20px; width:420px; max-width:94%; color:#fff; display:flex; flex-direction:column; gap:10px; box-shadow:0 12px 40px rgba(0,0,0,0.5); transform:translateY(20px); transition:transform .3s; }
  .popup input[type=text], .popup input[type=url], .popup input[type=password] { padding:10px 12px; border-radius:10px; border:none; background:rgba(255,255,255,0.06); color:#fff; outline:none; }
  .error-msg { color:#ff6b6b; font-size:0.9rem; display:none; }
  .user-info { position:absolute; bottom:10px; left:10px; display:flex; align-items:center; gap:10px; font-size:0.95rem; z-index:30; background: rgba(0,0,0,0.35); padding:8px 10px; border-radius:12px; backdrop-filter: blur(4px); border:1px solid rgba(255,255,255,0.04); }
  .user-info .name { font-weight:700; }
  .user-info .small-actions { display:flex; gap:6px; align-items:center; margin-left:8px; }
  .user-info .small-actions button { padding:6px 8px; font-size:0.85rem; background:transparent; border:1px solid rgba(255,255,255,0.06); color:inherit; border-radius:8px; }
  @media (max-width:800px){ .card { flex-direction:column; align-items:flex-start; height:auto; } .card-left{ width:100%; height:160px; } .rank { font-size:1.6rem; min-width:48px; } .card-top-right{ position:static; align-self:flex-end; margin-left:auto; } }
</style>
</head>
<body>
<div class="bg">
  <div class="glass">
    <div class="top-bar">
      <div class="title">Kacper's List — Leaderboard</div>
      <div style="display:flex; gap:10px; align-items:center;">
        <button class="btn" id="openPopup">Submit Hardest</button>
        <a href="submissions.html" class="btn btn-ghost" style="text-decoration:none; color:inherit;">Submissions</a>
      </div>
    </div>

    <div class="inner-rect">
      <div class="leaderboard-frame" id="leaderboardContainer">
        <!-- Cards injected here -->
      </div>
    </div>
  </div>
</div>

<!-- Submit Popup -->
<div class="overlay" id="submitOverlay">
  <div class="popup">
    <h3>Submit a Level</h3>
    <input type="text" id="subName" placeholder="Level Name">
    <div class="error-msg" id="errName">Level name required</div>
    <input type="text" id="subCreator" placeholder="Level Creator">
    <div class="error-msg" id="errCreator">Creator required</div>
    <input type="url" id="subYT" placeholder="YouTube Link (https://...)">
    <div class="error-msg" id="errYT">Valid YouTube link required</div>
    <div class="actions" style="display:flex; justify-content:flex-end;">
      <button class="btn" id="confirmSubmit">Submit</button>
    </div>
  </div>
</div>

<!-- Account Overlay -->
<div class="overlay" id="acctOverlay">
  <div class="popup" style="width:480px;">
    <div style="display:flex;gap:6px;margin-bottom:8px;">
      <div class="tab active" id="tabSignup">Sign up</div>
      <div class="tab" id="tabLogin">Login</div>
    </div>

    <div id="signupPanel">
      <h3>Create your username</h3>
      <input type="text" id="acctName" placeholder="Username (min 2 chars)">
      <input type="password" id="acctPass" placeholder="Password (min 4 chars)">
      <div class="error-msg" id="acctErr">Username/password required</div>
      <div class="error-msg" id="acctTaken">That username is already taken</div>
      <div style="display:flex; gap:8px; justify-content:flex-end;">
        <button class="btn" id="acctConfirm">Create</button>
      </div>
    </div>

    <div id="loginPanel" style="display:none;">
      <h3>Login</h3>
      <input type="text" id="loginName" placeholder="Username">
      <input type="password" id="loginPass" placeholder="Password">
      <div class="error-msg" id="loginErr">Username or password incorrect</div>
      <div style="display:flex; gap:8px; justify-content:flex-end;">
        <button class="btn" id="loginBtn">Login</button>
      </div>
    </div>
  </div>
</div>

<!-- Termination popup for banned users -->
<div class="overlay" id="terminatedOverlay">
  <div class="popup" style="width:420px;">
    <h3>Your account got terminated!</h3>
    <div id="terminatedReason" style="color:var(--muted)"></div>
    <div style="display:flex; justify-content:flex-end; gap:8px; margin-top:8px;">
      <button class="btn" id="termLogout">Log out</button>
    </div>
  </div>
</div>

<!-- bottom-left user info (no avatar) -->
<div class="user-info" id="userInfo" style="display:none;">
  <div style="display:flex; flex-direction:column;">
    <span class="name" id="userName">User</span>
    <small style="color:var(--muted)" id="userTag"></small>
  </div>
  <div class="small-actions">
    <button id="toggleUserInfo" title="Toggle user box">Hide</button>
    <button id="logoutBtn">Logout</button>
  </div>
</div>

<script>
/*
  index.html - client-only.
  IMPORTANT:
   - This script reads these files (GET):
       /users.json
       /submissions.json
       /leaderboard.json
       /terminated.json
     (these must be present on your GitHub Pages site or accessible at those paths)
   - Writing back to JSON on GitHub requires a GitHub token + owner/repo; that's implemented in submissions.html admin UI.
   - localStorage is cleared at load to avoid stale data; session (who is logged in) is kept in localStorage under 'siteUser' only.
*/

//////////////////////
// Utilities & clear localStorage
//////////////////////

// CLEAR legacy keys that were using localStorage for "shared" data
localStorage.removeItem('users');
localStorage.removeItem('submissions');
localStorage.removeItem('leaderboard');
localStorage.removeItem('terminatedUsers');
// keep siteUser session (we'll rewrite below) - but user asked to clear everything, so clear siteUser too:
localStorage.removeItem('siteUser');

function escapeHtml(s){ if(!s) return ''; return s.replace(/[&<>"']/g, function(m){ return {'&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;',"'":'&#39;'}[m]; }); }
function extractYouTubeId(url){ if(!url) return null; const regex = /(?:v=|\/embed\/|\.be\/|v\/|vi=)([A-Za-z0-9_-]{6,11})/; const m = url.match(regex); if(m && m[1]) return m[1]; return null; }
async function sha256(message){ const msgBuffer = new TextEncoder().encode(message); const hashBuffer = await crypto.subtle.digest('SHA-256', msgBuffer); const hashArray = Array.from(new Uint8Array(hashBuffer)); return hashArray.map(b=>b.toString(16).padStart(2,'0')).join(''); }

//////////////////////
// Paths to JSON files (relative URLs on your GitHub Pages)
// Ensure these files exist in your repo root (or adjust paths)
//////////////////////
const PATH_USERS = '/users.json';
const PATH_SUBMISSIONS = '/submissions.json';
const PATH_LEADERBOARD = '/leaderboard.json';
const PATH_TERMINATED = '/terminated.json';

//////////////////////
// App state (will be populated from fetch)
//////////////////////
let usersData = [];
let submissionsData = [];
let leaderboardData = [];
let terminatedData = {}; // { "<username>": { reason, timestamp } }

let siteUser = null; // logged-in user (object) — saved to localStorage.siteUser for session only

// DOM refs
const submitOverlay = document.getElementById('submitOverlay');
const openPopup = document.getElementById('openPopup');
const confirmSubmit = document.getElementById('confirmSubmit');
const leaderboardContainer = document.getElementById('leaderboardContainer');
const userInfoBox = document.getElementById('userInfo');
const userNameEl = document.getElementById('userName');
const userTagEl = document.getElementById('userTag');
const logoutBtn = document.getElementById('logoutBtn');
const toggleUserInfoBtn = document.getElementById('toggleUserInfo');

const acctOverlay = document.getElementById('acctOverlay');
const signupPanel = document.getElementById('signupPanel');
const loginPanel = document.getElementById('loginPanel');
const tabSignup = document.getElementById('tabSignup');
const tabLogin = document.getElementById('tabLogin');

const acctNameEl = document.getElementById('acctName');
const acctPassEl = document.getElementById('acctPass');
const acctErr = document.getElementById('acctErr');
const acctTaken = document.getElementById('acctTaken');
const acctConfirm = document.getElementById('acctConfirm');

const loginNameEl = document.getElementById('loginName');
const loginPassEl = document.getElementById('loginPass');
const loginErr = document.getElementById('loginErr');
const loginBtn = document.getElementById('loginBtn');

const terminatedOverlay = document.getElementById('terminatedOverlay');
const terminatedReasonEl = document.getElementById('terminatedReason');
const termLogoutBtn = document.getElementById('termLogout');

//////////////////////
// Fetch JSON helper (reads; returns default when file missing)
//////////////////////
async function fetchJsonOrDefault(path, defaultVal){
  try{
    const res = await fetch(path + '?_=' + Date.now(), {cache: 'no-store'}); // avoid aggressive caching
    if(!res.ok) return defaultVal;
    return await res.json();
  }catch(e){
    return defaultVal;
  }
}

//////////////////////
// Boot: load data from JSON files on server
//////////////////////
async function boot(){
  // try to restore logged-in session if present
  try{
    siteUser = JSON.parse(localStorage.getItem('siteUser') || 'null');
  }catch(e){ siteUser = null; }

  // load server JSONs (read-only)
  usersData = await fetchJsonOrDefault(PATH_USERS, []);
  submissionsData = await fetchJsonOrDefault(PATH_SUBMISSIONS, []);
  leaderboardData = await fetchJsonOrDefault(PATH_LEADERBOARD, []);
  terminatedData = await fetchJsonOrDefault(PATH_TERMINATED, {});

  // sanitize missing fields
  if(!Array.isArray(usersData)) usersData = [];
  if(!Array.isArray(submissionsData)) submissionsData = [];
  if(!Array.isArray(leaderboardData)) leaderboardData = [];
  if(typeof terminatedData !== 'object' || terminatedData === null) terminatedData = {};

  // if siteUser exists, validate against usersData (and check ban)
  if(siteUser){
    const u = usersData.find(x=> (x.username && x.username.toLowerCase()=== (siteUser.username||'').toLowerCase()) );
    if(!u){
      // user no longer exists: clear session
      siteUser = null;
      localStorage.removeItem('siteUser');
    } else {
      // check banned
      if(u.isBanned){
        // show termination overlay with reason
        const reason = u.banReason || (terminatedData[u.username] && terminatedData[u.username].reason) || 'No reason provided';
        showTermination(reason);
        return; // don't show rest (they must logout)
      }
      // update session with fresh user object
      siteUser = u;
      localStorage.setItem('siteUser', JSON.stringify(siteUser));
    }
  }

  updateUserUI();
  loadLeaderboard();
  if(!siteUser){
    showAcctOverlay();
  }
}

//////////////////////
// UI helpers: overlays
//////////////////////
function showAcctOverlay(){ acctOverlay.classList.add('active'); acctOverlay.style.display = 'flex'; }
function hideAcctOverlay(){ acctOverlay.classList.remove('active'); acctOverlay.style.display = 'none'; }
function showSubmitOverlay(){ submitOverlay.classList.add('active'); submitOverlay.style.display='flex'; }
function hideSubmitOverlay(){ submitOverlay.classList.remove('active'); submitOverlay.style.display='none'; }
function showTermination(reason){
  terminatedReasonEl.textContent = reason;
  terminatedOverlay.classList.add('active'); terminatedOverlay.style.display='flex';
}
function hideTermination(){
  terminatedOverlay.classList.remove('active'); terminatedOverlay.style.display = 'none';
}

//////////////////////
// User helpers
//////////////////////
function findUserByName(name){ if(!name) return null; return usersData.find(u => u.username.toLowerCase() === name.toLowerCase()) || null; }
function generateTag(){
  const taken = new Set(usersData.map(u => u.tag));
  for(let i=1;i<10000;i++){ const t = String(i).padStart(4,'0'); if(!taken.has(t)) return t; }
  return String(Date.now()).slice(-4);
}
function setSiteUser(user){
  siteUser = user;
  localStorage.setItem('siteUser', JSON.stringify(user));
  updateUserUI();
}
function clearSiteUser(){
  siteUser = null;
  localStorage.removeItem('siteUser');
  updateUserUI();
}

function updateUserUI(){
  if(!siteUser){ userInfoBox.style.display='none'; return; }
  userInfoBox.style.display='flex';
  userNameEl.textContent = siteUser.username;
  userTagEl.textContent = siteUser.tag ? ('#' + siteUser.tag) : '';
  // MTO badge
  const mtoBadge = document.getElementById('mtoBadge');
  if(siteUser.mto){
    if(!mtoBadge){
      const badge = document.createElement('span');
      badge.id='mtoBadge';
      badge.textContent='MTO';
      badge.style.marginLeft='6px';
      badge.style.padding='2px 6px';
      badge.style.fontSize='0.75rem';
      badge.style.fontWeight='700';
      badge.style.color='#000';
      badge.style.background='linear-gradient(135deg,#ffdd55,#ffaa33)';
      badge.style.borderRadius='6px';
      userNameEl.parentNode.appendChild(badge);
    }
  } else if(mtoBadge) {
    mtoBadge.remove();
  }
}

//////////////////////
// Signup & Login (client-side hashed passwords)
// NOTE: to persist users.json on GitHub you must use admin writes (submissions page)
//////////////////////
tabSignup.addEventListener('click', ()=>{
  tabSignup.classList.add('active'); tabLogin.classList.remove('active');
  signupPanel.style.display='block'; loginPanel.style.display='none';
});
tabLogin.addEventListener('click', ()=>{
  tabLogin.classList.add('active'); tabSignup.classList.remove('active');
  signupPanel.style.display='none'; loginPanel.style.display='block';
});

// Signup flow: create user locally and attempt to persist via GitHub (admin must run commit from submissions page)
acctConfirm.addEventListener('click', async ()=>{
  const name = acctNameEl.value.trim();
  const pass = acctPassEl.value || '';
  acctErr.style.display='none';
  acctTaken.style.display='none';
  if(!name || name.length < 2 || !pass || pass.length < 4){ acctErr.textContent='Username must be ≥2 chars and password ≥4 chars'; acctErr.style.display='block'; return; }
  if(findUserByName(name)){ acctTaken.style.display='block'; return; }

  const hashed = await sha256(pass);
  const newUser = { username: name, tag: generateTag(), passwordHash: hashed, createdAt: Date.now(), isBanned:false, mto:false };
  usersData.push(newUser);

  // Set session now (local), but persistence to users.json requires admin commit. Show notice
  setSiteUser(newUser);
  hideAcctOverlay();
  alert('Account created locally. NOTE: to persist users across everyone, you (an admin) must update users.json in your repo (the admin tools in submissions.html can do that if you provide a GitHub token).');
});

// Login: compare password hash with usersData
loginBtn.addEventListener('click', async ()=>{
  const name = loginNameEl.value.trim();
  const pass = loginPassEl.value || '';
  loginErr.style.display='none';
  if(!name || !pass){ loginErr.textContent='Username or password incorrect'; loginErr.style.display='block'; return; }
  const user = findUserByName(name);
  if(!user){ loginErr.textContent='Username or password incorrect'; loginErr.style.display='block'; return; }
  const hashed = await sha256(pass);
  if(user.passwordHash !== hashed){ loginErr.textContent='Username or password incorrect'; loginErr.style.display='block'; return; }

  if(user.isBanned){
    const reason = user.banReason || (terminatedData[user.username] && terminatedData[user.username].reason) || 'No reason provided';
    showTermination(reason);
    return;
  }

  setSiteUser(user);
  hideAcctOverlay();
});

logoutBtn.addEventListener('click', ()=>{ if(confirm('Logout?')){ clearSiteUser(); showAcctOverlay(); } });
termLogoutBtn.addEventListener('click', ()=>{ clearSiteUser(); hideTermination(); showAcctOverlay(); });

//////////////////////
// Submissions: create submission object and save to submissionsData locally
// Writes to server JSON require admin write via GitHub API (handled on submissions.html)
//////////////////////
openPopup.addEventListener('click', ()=>{ if(!siteUser){ showAcctOverlay(); return; } showSubmitOverlay(); });

confirmSubmit.addEventListener('click', ()=>{
  const name = document.getElementById('subName').value.trim();
  const creator = document.getElementById('subCreator').value.trim();
  const yt = document.getElementById('subYT').value.trim();
  const errName = document.getElementById('errName');
  const errCreator = document.getElementById('errCreator');
  const errYT = document.getElementById('errYT');

  let ok = true;
  if(!siteUser?.mto){
    if(!name){ errName.style.display='block'; ok=false; } else errName.style.display='none';
    if(!creator){ errCreator.style.display='block'; ok=false; } else errCreator.style.display='none';
    if(!/^https?:\/\//.test(yt) || !extractYouTubeId(yt)){ errYT.style.display='block'; errYT.textContent='Valid YouTube link required'; ok=false; } else errYT.style.display='none';
  }

  if(!ok) return;

  const entry = { name, creator, youtube: yt, submittedBy: siteUser ? siteUser.username : 'Unknown', submittedAt: Date.now() };
  submissionsData.push(entry);

  // Save to server is not automatic; notify admin
  hideSubmitOverlay();
  document.getElementById('subName').value=''; document.getElementById('subCreator').value=''; document.getElementById('subYT').value='';
  alert('Submission saved locally in this browser. To make it visible to everyone, an admin must approve it (use submissions.html admin tools).');
});

//////////////////////
// Render leaderboard - note: we ONLY render approved / persisted leaderboard.json
//////////////////////
function loadLeaderboard(){
  leaderboardContainer.innerHTML = '';
  // leaderboardData contains approved entries (rank, name, creator, youtube, submittedBy)
  const list = (Array.isArray(leaderboardData) ? leaderboardData : []).map(x=>({...x, rank: Number(x.rank) || 9999})).sort((a,b)=>a.rank-b.rank);

  if(list.length === 0){
    const empty = document.createElement('div');
    empty.style.opacity = 0.7; empty.style.color = 'var(--muted)'; empty.style.marginTop = '20px'; empty.style.textAlign = 'center';
    empty.textContent = 'No leaderboard entries yet — be first to submit (admins must approve).';
    leaderboardContainer.appendChild(empty);
    return;
  }

  list.forEach(item=>{
    const card = document.createElement('div'); card.className='card';
    const left = document.createElement('div'); left.className='card-left';
    const ytId = extractYouTubeId(item.youtube);
    if(ytId){ const iframe=document.createElement('iframe'); iframe.src=`https://www.youtube.com/embed/${ytId}`; iframe.allow='accelerometer; autoplay; clipboard-write; encrypted-media; gyroscope; picture-in-picture'; iframe.allowFullscreen=true; left.appendChild(iframe); } else { left.textContent='No video'; }
    const mid = document.createElement('div'); mid.className='card-mid';
    const rankRow = document.createElement('div'); rankRow.className='rank-row';
    const rankEl = document.createElement('div'); rankEl.className='rank'; rankEl.textContent = item.rank || '-';
    const nameEl = document.createElement('div'); nameEl.className='level-name'; nameEl.textContent = item.name || 'Unknown level';
    rankRow.appendChild(rankEl); rankRow.appendChild(nameEl);
    const creator = document.createElement('div'); creator.className='creator'; creator.textContent = 'by ' + (item.creator || 'Unknown');
    mid.appendChild(rankRow); mid.appendChild(creator);
    const topRight = document.createElement('div'); topRight.className='card-top-right';
    const sender = item.submittedBy || item.discord || item.username || 'Unknown';
    topRight.textContent = 'sent by ' + sender;

    card.appendChild(left); card.appendChild(mid); card.appendChild(topRight);
    leaderboardContainer.appendChild(card);
  });
}

// expose (for admin page to call)
window.loadLeaderboard = loadLeaderboard;

//////////////////////
// Start boot
//////////////////////
boot();

</script>
</body>
</html>
